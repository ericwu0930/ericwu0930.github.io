<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="Eric&#39;s Blog">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="https://ericwu0930.github.io/img/roof.jpg">
    <meta property="twitter:image" content="https://ericwu0930.github.io/img/roof.jpg" />
    

    
    <meta name="title" content="Redis数据库" />
    <meta property="og:title" content="Redis数据库" />
    <meta property="twitter:title" content="Redis数据库" />
    

    
    <meta name="description" content="本文重点讲解Redis数据库结构">
    <meta property="og:description" content="本文重点讲解Redis数据库结构" />
    <meta property="twitter:description" content="本文重点讲解Redis数据库结构" />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="吴昊, Eric Wu, 吴昊的博客, Eric&#39;s Blog, 博客, 个人网站, 互联网, Web, 云原生, PaaS, Istio, Kubernetes, 微服务, Microservice">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>Redis数据库 | 吴昊的博客 | Eric&#39;s Blog</title>

    <link rel="canonical" href="/post/expire/">

    
    
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hugo-theme-cleanwhite.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">

    
    <link href="https://cdn.jsdelivr.net/gh/FortAwesome/Font-Awesome@5.15.1/css/all.css" rel="stylesheet" type="text/css">

    
    

    
    <script src="/js/jquery.min.js"></script>

    
    <script src="/js/bootstrap.min.js"></script>

    
    <script src="/js/hux-blog.min.js"></script>

    
    <script src="/js/lazysizes.min.js"></script>

    
    

</head>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-158682233-1', 'auto');
	
	ga('send', 'pageview');
}
</script>





<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Eric&#39;s Blog</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">All Posts</a>
                    </li>
                    
                        
                        <li>
                            <a href="/categories/java">java</a>
                        </li>
                        
                        <li>
                            <a href="/categories/jvm">jvm</a>
                        </li>
                        
                        <li>
                            <a href="/categories/linux">linux</a>
                        </li>
                        
                        <li>
                            <a href="/categories/mysql">mysql</a>
                        </li>
                        
                        <li>
                            <a href="/categories/os">os</a>
                        </li>
                        
                        <li>
                            <a href="/categories/redis">redis</a>
                        </li>
                        
                        <li>
                            <a href="/categories/spring">spring</a>
                        </li>
                        
                        <li>
                            <a href="/categories/trivial">trivial</a>
                        </li>
                        
                        <li>
                            <a href="/categories/%E7%AE%97%E6%B3%95">算法</a>
                        </li>
                        
                        <li>
                            <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C">计算机网络</a>
                        </li>
                        
                        <li>
                            <a href="/categories/%E9%9A%8F%E7%AC%94">随笔</a>
                        </li>
                        
                    
                    
		    
                        <li><a href="/top/about/">ABOUT</a></li>
                    
		            <li>
                        <a href="/search"><i class="fa fa-search"></i></a>
		           </li>
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('/img/roof.jpg')
    }
</style>

<header class="intro-header" >

    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0" title="学习笔记">
                            学习笔记
                        </a>
                        
                    </div>
                    <h1>Redis数据库</h1>
                    <h2 class="subheading">整理自《Redis设计与实现》</h2>
                    <span class="meta">
                        
                            Posted by 
                            
                                     &#34;Eric&#34;
                             
                            on 
                            Friday, September 11, 2020
                            
                            
                            
                            
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                
                <h2 id="1服务器中数据库结构">1.服务器中数据库结构</h2>
<p>在redis服务器中，服务器的各种状态由<code>redis.h/redisServer</code>所维护，其中db字段指向<code>redis.h/redisDb</code>数组，每个<code>redisDB</code>结构代表一个数据库</p>
<p>
  <img src="https://raw.githubusercontent.com/ericwu0930/picture_host/main/image-20230225145855001.png" alt="image-20230225145855001">

</p>
<p>在<code>redis.h/redisDB</code>结构中，<code>dict</code>字段保留了数据库中所有的键值对。</p>
<p>
  <img src="https://raw.githubusercontent.com/ericwu0930/picture_host/main/image-20230225150229948.png" alt="image-20230225150229948">

</p>
<h2 id="2-设置键的生存时间或过期时间">2. 设置键的生存时间或过期时间</h2>
<p>在Redis中，可以对任意键设置一个生存时间，有以下四个命令，他们之间的关系如下，其中以P开头的表明时间单位为毫秒；以AT结尾的表名在timestamp时刻过期。不管是执行这四个之中的何种命令，最终都会转化成PEXPIREAT这条命令执行，然后在redistDb结构中，会用一个expires字典保存数据库中所有键的过期时间。</p>
<p>
  <img src="https://raw.githubusercontent.com/ericwu0930/picture_host/main/image-20221229180750519.png" alt="image-20221229180750519">

</p>
<p>通过过期字典，程序可以用以下步骤检查一个给定键是否过期：</p>
<ol>
<li>检查给定键是否存在于过期字典：如果存在，那么取得过期键的过期时间</li>
<li>检查当前UNIX时间戳是否大于键的过期时间：如果是的话，那么键已经过期；否则的话，键未过期。</li>
</ol>
<p>
  <img src="https://raw.githubusercontent.com/ericwu0930/picture_host/main/image-20221229180803463.png" alt="image-20221229180803463">

</p>
<h2 id="3-过期键的删除策略">3. 过期键的删除策略</h2>
<p>Redis服务器使用了惰性删除和定期删除两种策略；所谓的惰性删除就是在访问该键时才检查键是否过期。定期删除每隔一段时间执行一次删除过期键的操作。</p>
<p>过期键的惰性删除策略由db.c/expireIfNeeded函数实现，所有读写数据库的Redis命令在执行之前都会调用expireIfNeeded函数对输入键进行检查</p>
<p>
  <img src="https://raw.githubusercontent.com/ericwu0930/picture_host/main/image-20230225155658221.png" alt="image-20230225155658221">

</p>
<p>过期键的定期删除策略由redis.c/activeExpireCycle函数实现，每当Redis的服务器周期性操作redis.c/serverCron函数执行时，activeExpireCycle函数就会被调用，它在规定的时间内，分多次遍历服务器中的各个数据库，并删除其中的过期键。</p>
<h2 id="4-内存淘汰策略">4. 内存淘汰策略</h2>
<p>Redis的内存不是无限大的，达到阈值时需要淘汰不分内存数据，其有8中内存淘汰策略：</p>
<ul>
<li>noeviction（默认策略，不淘汰）</li>
<li>volatile-lru （Least Recently Used的缩写，即最近最少使用）</li>
<li>volatile-lfu（Least frequently used的缩写，即最少次数使用）</li>
<li>volatile-ttl（time to live的缩写，最近要过期的）</li>
<li>volatile-random （随机淘汰）</li>
<li>alllkeys-lru</li>
<li>allkeys-lfu</li>
<li>allkeys-random</li>
</ul>
<p>其中volatile前缀指的是淘汰策略只在设置了过期时间的key上进行，allkeys则指的是淘汰策略针对所有的键进行。</p>
<h2 id="5-持久化策略">5. 持久化策略</h2>
<p>redis中有两种持久化策略——RDB和AOF，其中RDB即Redis DataBase，指的是内存快照；AOF则是Append Only File，是对命令的记录。</p>
<h3 id="51-rdb">5.1 RDB</h3>
<p>rdb有两种触发方式，<strong>手动触发</strong>和<strong>自动触发</strong>。</p>
<p>其中手动触发又有两种方式——<code>save</code>命令和<code>bgsave</code>命令。其区别可见以下伪代码</p>
<pre tabindex="0"><code>def SAVE():
	# 创建RDB文件
	rdbSave()
	
def BGSAVE():
	pid = fork()
	if pid == 0:
		# 子进程逻辑
		rdbSave()
		# 父进程逻辑
		signal_parent()
	elif pid &gt; 0:
		# 父进程继续处理命令请求
		handle_request_and_wait_signal()
	else:
		# 报错
</code></pre><p>可见save是阻塞式的，bgsave则是非阻塞式的。</p>
<p>对于自动触发而言，可以在<code>redis.conf</code>文件中进行配置。</p>
<p>如果Redis开辟的区域比较大，将内存中的数据同步到硬盘的过程中可能会持续较长时间，这个时候如果Redis收到数据写操作的时候，该如何保证数据的一致性呢？在执行<code>fork</code>后，子进程和父进程是独立的内存空间，因此<code>bgsave</code>子进程读到的是redis键值对的副本。主进程对redis键值对的修改并不影响<code>bgsave</code>子进程。</p>
<p>
  <img src="https://raw.githubusercontent.com/ericwu0930/picture_host/main/image-20230225173008275.png" alt="image-20230225173008275">

</p>
<h3 id="52-aof">5.2 AOF</h3>
<p>Redis的AOF持久化是针对命令而言的，其包含<strong>追加、文件写入、文件同步</strong>三个步骤。</p>
<h4 id="521-aof执行时机">5.2.1 AOF执行时机</h4>
<ul>
<li>命令追加</li>
</ul>
<p>在<code>redis.h/redisServer</code>结构中会存在一个<code>aof_buf</code>字段，如果AOF持久化功能处于打开状态时，服务器在执行完一个写命令后，会以协议格式将被执行的写命令追加到<code>aof_buf</code>缓冲区的末尾。</p>
<ul>
<li>文件写入和同步</li>
</ul>
<p>Redis的服务进程是一个事件循环，接收命令请求以及发送命令属于文件事件；时间事件负责执行<code>serverCron</code>函数这样需要定时运行的函数。</p>
<pre tabindex="0"><code>def eventLoop():
	while True:
		# 处理文件事件，包括接收命令请求以及发送命令回复，命令追加到aof_buf中会发生在此处
		processFileEvents()
		# 处理时间事件
		processTimeEvents()
		# 将aof_buf中的内容写入和同步到AOF中
		flushAppendOnlyFile()
</code></pre><p>控制何时将<code>aof_buf</code>缓冲区的内容写入AOF文件中的有三种写回策略</p>
<table>
<thead>
<tr>
<th>配置项</th>
<th>写回时机</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody>
<tr>
<td>Always</td>
<td>同步写回</td>
<td>可靠性高，数据基本不丢失</td>
<td>每个写命令都要落盘，性能影响较大</td>
</tr>
<tr>
<td>Everysec</td>
<td>每秒写回</td>
<td>性能适中</td>
<td>宕机时丢失1秒内的数据</td>
</tr>
<tr>
<td>No</td>
<td>操作系统控制的写回</td>
<td>性能好</td>
<td>宕机时丢失数据较多</td>
</tr>
</tbody>
</table>
<blockquote>
<p>所谓的文件写入和同步，即Java文件流中的write和flush，写入指写入到缓冲区中，flush则指刷入硬盘中</p>
</blockquote>
<h4 id="522-aof重写">5.2.2 AOF重写</h4>
<p>随着时间推移，AOF文件会越来越大。为了压缩AOF文件的体积，删减无效的命令，Redis会执行AOF重写命令<code>beginrewriteaof</code>。</p>
<p>在进行AOF重新的过程中，Redis会直接读取<strong>服务器当前的数据库状态</strong>创建一个新的AOF文件代替现有的AOF文件。</p>
<p>因为在Redis中<strong>使用单线程处理命令请求</strong>，如果同步执行AOF重写则会阻塞整个进程。</p>
<p>
  <img src="https://raw.githubusercontent.com/ericwu0930/picture_host/main/image-20230225193727553.png" alt="image-20230225193727553">

</p>
<h2 id="6-事件">6. 事件</h2>
<p>Redis采用事件驱动的方式来处理大量的网络IO。服务器需要处理以下两类事件：</p>
<ul>
<li>文件事件：文件事件是服务器对套接字操作的抽象，服务器与客户端的通信会产生相应的文件事件，服务器通过监听这些事件来完成一系列网络通信。</li>
<li>时间事件：对Redis中事件操作的抽象。</li>
</ul>
<blockquote>
<p>所谓事件驱动指的是服务端提前写好回调函数，一个事件到来后，根据事件的类型，触发相应的回调函数，而不是主动等待事件的到来。</p>
</blockquote>
<h3 id="61-文件事件">6.1 文件事件</h3>
<p>Redis因为主要对内存进行操作，所以为了节省开发量，所以在**核心的命令处理上（键值对的读写）**使用单线程开发。</p>
<p>文件事件是对套接字操作的抽象，每当一个套接字准备好执行<code>accept</code>、<code>read</code>、<code>write</code>和<code>close</code>等操作时，就会产生一个文件事件。Redis连接多个套接字，多个文件事件可能并发出现，redis使用I/O多路复用的方式负责监听多个套接字，并向文件事件派发器传递这些事件的套接字。</p>
<p>
  <img src="https://raw.githubusercontent.com/ericwu0930/picture_host/main/image-20230226111208802.png" alt="image-20230226111208802">

</p>
<blockquote>
<p>以linux的select为例，服务器会新建一个socket监听，这个socket会返回一个fd，将这个fd纳入到select的监听set中（该fd专门表示服务器监听套接字的fd）；当该fd准备好被accept后，此时会返回客户端套接字，然后将该套接字也放入到select中，用于监听该套接字是否可读可写。</p>
</blockquote>
<p>为了便于理解IO多路复用，一个使用select实现多路复用的demo如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/types.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/socket.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;errno.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;netinet/in.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;arpa/inet.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> MYPORT <span style="color:#f92672">=</span> <span style="color:#ae81ff">1240</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> BACKLOG <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> BUF_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">1024</span>;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>using namespace std;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> sock_fd,new_fd;
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> sockaddr_in server_addr,client_addr;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> buf[BUF_SIZE];
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 新建socket
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>((sock_fd <span style="color:#f92672">=</span> <span style="color:#a6e22e">socket</span>(AF_INET,SOCK_STREAM,<span style="color:#ae81ff">0</span>)) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">perror</span>(<span style="color:#e6db74">&#34;socket&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> yes <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;<span style="color:#75715e">//yes = 1;(即TRUE)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">setsockopt</span>(sock_fd, SOL_SOCKET, SO_REUSEADDR, <span style="color:#f92672">&amp;</span>yes,<span style="color:#66d9ef">sizeof</span>(yes)) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">perror</span>(<span style="color:#e6db74">&#34;setsockopt&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span>    server_addr.sin_family <span style="color:#f92672">=</span> AF_INET;
</span></span><span style="display:flex;"><span>    server_addr.sin_port <span style="color:#f92672">=</span> <span style="color:#a6e22e">htons</span>(MYPORT);
</span></span><span style="display:flex;"><span>    server_addr.sin_addr.s_addr <span style="color:#f92672">=</span> INADDR_ANY;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memset</span>(server_addr.sin_zero,<span style="color:#e6db74">&#39;0&#39;</span>,<span style="color:#66d9ef">sizeof</span>(server_addr.sin_zero));
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 绑定地址
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">bind</span>(sock_fd, (<span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span> )<span style="color:#f92672">&amp;</span>server_addr, <span style="color:#66d9ef">sizeof</span>(server_addr)) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">perror</span>(<span style="color:#e6db74">&#34;bind&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 开始监听
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">listen</span>(sock_fd, BACKLOG) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">perror</span>(<span style="color:#e6db74">&#34;listen&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span>    fd_set fdsr;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> maxsock;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> i;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> timeval tv;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> fd_A[BACKLOG];<span style="color:#75715e">//客户端套接字
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> con_amount <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> ret;
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span>    maxsock <span style="color:#f92672">=</span> sock_fd;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//int sin_size = sizeof(client_addr);//int len ;  wrong
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">socklen_t</span> sin_size <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(client_addr);
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// select函数会清空它所检测的socket描述符集合，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      	<span style="color:#75715e">// 导致每次调用select()之前都必须把socket描述符重新加入到待检测的集合中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">FD_ZERO</span>(<span style="color:#f92672">&amp;</span>fdsr);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">FD_SET</span>(sock_fd, <span style="color:#f92672">&amp;</span>fdsr);
</span></span><span style="display:flex;"><span>         
</span></span><span style="display:flex;"><span>        tv.tv_sec <span style="color:#f92672">=</span> <span style="color:#ae81ff">30</span>;<span style="color:#75715e">//每一次查询  套接字是否就绪的时间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        tv.tv_usec <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> con_amount; i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (fd_A[i] <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">FD_SET</span>(fd_A[i],<span style="color:#f92672">&amp;</span>fdsr);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>         
</span></span><span style="display:flex;"><span>        ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">select</span>(maxsock <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, <span style="color:#f92672">&amp;</span>fdsr, NULL, NULL, <span style="color:#f92672">&amp;</span>tv);<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (ret <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">perror</span>(<span style="color:#e6db74">&#34;select&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (ret <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)<span style="color:#75715e">// 没有准备就绪的文件描述符  就进入下一次循环
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        {
</span></span><span style="display:flex;"><span>            cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;timeout&#34;</span> <span style="color:#f92672">&lt;&lt;</span> endl;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//有准备就绪的套接字，则分别检查哪些  客户端套接字 和 监听套接字 已经就绪  分别进行数据读取和建立连接
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> con_amount; i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>        {		<span style="color:#75715e">// 如果客户端套接字准备好了
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">FD_ISSET</span>(fd_A[i], <span style="color:#f92672">&amp;</span>fdsr))
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">recv</span>(fd_A[i], buf, BUF_SIZE <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (ret <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    buf[ret] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;\0&#39;</span>;
</span></span><span style="display:flex;"><span>                    cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;msg from &#34;</span> <span style="color:#f92672">&lt;&lt;</span> fd_A[i] <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;is: &#34;</span> <span style="color:#f92672">&lt;&lt;</span> buf <span style="color:#f92672">&lt;&lt;</span> endl;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span><span style="color:#75715e">//------------------client close 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                {
</span></span><span style="display:flex;"><span>                    cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;client &#34;</span> <span style="color:#f92672">&lt;&lt;</span> fd_A[i] <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34; is closed!&#34;</span> <span style="color:#f92672">&lt;&lt;</span> endl;
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">close</span>(fd_A[i]);
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">//FD_CLR(fd_A[i],&amp;fdsr);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    fd_A[i] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                    perro(&#34;recv&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                    exit(1);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                    */</span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 如果监听套接字准备好了
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">FD_ISSET</span>(sock_fd, <span style="color:#f92672">&amp;</span>fdsr))
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ((new_fd <span style="color:#f92672">=</span> <span style="color:#a6e22e">accept</span>(sock_fd, (<span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>client_addr, <span style="color:#f92672">&amp;</span>sin_size)) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">perror</span>(<span style="color:#e6db74">&#34;accept&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 如果没超过连接上线，则将信的客户端套接字加入到fd_A中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> (con_amount <span style="color:#f92672">&lt;</span> BACKLOG)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                fd_A[con_amount<span style="color:#f92672">++</span>] <span style="color:#f92672">=</span> new_fd;
</span></span><span style="display:flex;"><span>                cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;new client:&#34;</span> <span style="color:#f92672">&lt;&lt;</span><span style="color:#a6e22e">inet_ntoa</span>(client_addr.sin_addr) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;:&#34;</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#a6e22e">ntohs</span>(client_addr.sin_port) <span style="color:#f92672">&lt;&lt;</span> endl;
</span></span><span style="display:flex;"><span>                 
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">//update maxsock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> (new_fd <span style="color:#f92672">&gt;</span> maxsock)
</span></span><span style="display:flex;"><span>                    maxsock <span style="color:#f92672">=</span> new_fd;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Max connections arrived!&#34;</span> <span style="color:#f92672">&lt;&lt;</span> endl;
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">send</span>(new_fd, <span style="color:#e6db74">&#34;Bye&#34;</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">close</span>(new_fd);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }<span style="color:#75715e">//end of &#34;while(1)&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="62-时间事件">6.2 时间事件</h3>
<p>在Redis中会将所有的时间事件用一个无序list进行连接，如下图所示</p>
<p>
  <img src="https://raw.githubusercontent.com/ericwu0930/picture_host/main/image-20230226120855772.png" alt="image-20230226120855772">

</p>
<p>其中when字段表示下次该时间事件被触发的时间。</p>
<p>通常情况下，Redis服务器中只有一个serverCron时间事件，上面的无需联表也就退化成了一个指针。</p>
<h3 id="63-事件的调度与执行">6.3 事件的调度与执行</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">aeMain</span>(aeEventLoop <span style="color:#f92672">*</span>eventLoop) {
</span></span><span style="display:flex;"><span>    eventLoop<span style="color:#f92672">-&gt;</span>stop <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span>eventLoop<span style="color:#f92672">-&gt;</span>stop) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* 如果有需要在事件处理前执行的函数，那么执行它 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (eventLoop<span style="color:#f92672">-&gt;</span>beforesleep <span style="color:#f92672">!=</span> NULL)
</span></span><span style="display:flex;"><span>            eventLoop<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">beforesleep</span>(eventLoop);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* 开始处理事件*/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">aeProcessEvents</span>(eventLoop, AE_ALL_EVENTS<span style="color:#f92672">|</span>AE_CALL_AFTER_SLEEP);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/* 伪代码 */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">aeProcessEvents</span>(aeEventLoop <span style="color:#f92672">*</span>eventLoop, <span style="color:#66d9ef">int</span> flags) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* 获取到达时间距离当前时间最接近的时间事件*/</span>
</span></span><span style="display:flex;"><span>    time_event <span style="color:#f92672">=</span> <span style="color:#a6e22e">aeSearchNearestTimer</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* 计算最接近的时间事件距离到达还有多少毫秒*/</span>
</span></span><span style="display:flex;"><span>    remaind_ms <span style="color:#f92672">=</span> time_event.when <span style="color:#f92672">-</span> <span style="color:#a6e22e">unix_ts_now</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* 如果事件已经到达，那么remaind_ms为负数，将其设置为0 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (remaind_ms <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) remaind_ms <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* 根据 remaind_ms 的值，创建 timeval 结构*/</span>
</span></span><span style="display:flex;"><span>    timeval <span style="color:#f92672">=</span> <span style="color:#a6e22e">create_timeval_with_ms</span>(remaind_ms);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* 阻塞并等待文件事件产生，最大阻塞时间由传入的 timeval 结构决定，如果remaind_ms 的值为0，则aeApiPoll 调用后立刻返回，不阻塞*/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* aeApiPoll调用epoll_wait函数，等待I/O事件*/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">aeApiPoll</span>(timeval);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* 处理所有已经产生的文件事件*/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">processFileEvents</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* 处理所有已经到达的时间事件*/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">processTimeEvents</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>其中<code>aeEventLoop</code>结构如下图所示</p>
<p>
  <img src="https://raw.githubusercontent.com/ericwu0930/picture_host/main/image-20230226121829595.png" alt="image-20230226121829595">

</p>


                

                
                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/post/privilege/" data-toggle="tooltip" data-placement="top" title="内核态和用户态">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/post/myuniversity/" data-toggle="tooltip" data-placement="top" title="我的大学（转）">Next
                            Post &rarr;</a>
                    </li>
                    
                </ul>
                

                



            </div>

            
            
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
            

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                
                

                
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">                  
                    
                    <li>
                        <a href="mailto:is.eric.wu@gmail.com">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://weibo.com/1965461781/profile?rightmod=1&amp;wvr=6&amp;mod=personinfo">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    

		            
                    
                    <li>
                        <a target="_blank" href="/img/we_chat.JPG">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-weixin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    <li>
                        <a target="_blank" href="https://github.com/ericwu0930/">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://www.linkedin.com/in/hao-wu-5566a416a">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    
                    
                    
                    
                    
            
            
            
           
             </ul>
		<p class="copyright text-muted">
                    Copyright &copy; Eric&#39;s Blog 2023
                    <br>
                    <a href="https://themes.gohugo.io/hugo-theme-cleanwhite">CleanWhite Hugo Theme</a> by <a href="https://zhaohuabing.com">Huabing</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function loadAsync(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        loadAsync("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>






<script type="text/javascript">
    function generateCatalog(selector) {

        
        
        
        
            _containerSelector = 'div.post-container'
        

        
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        
        $(selector).html('')

        
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    


    loadAsync("\/js\/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>






</body>
</html>
