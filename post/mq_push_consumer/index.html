<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="Eric&#39;s Blog">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="https://ericwu0930.github.io/img/roof.jpg">
    <meta property="twitter:image" content="https://ericwu0930.github.io/img/roof.jpg" />
    

    
    <meta name="title" content="RocketMQ源码分析（一）—— DefaultPushConsumer" />
    <meta property="og:title" content="RocketMQ源码分析（一）—— DefaultPushConsumer" />
    <meta property="twitter:title" content="RocketMQ源码分析（一）—— DefaultPushConsumer" />
    

    
    <meta name="description" content="RocketMQ中有两种类型的消费者，Push和Pull，本篇文章将分析RocketMQ DefaultPushConsumer源码">
    <meta property="og:description" content="RocketMQ中有两种类型的消费者，Push和Pull，本篇文章将分析RocketMQ DefaultPushConsumer源码" />
    <meta property="twitter:description" content="RocketMQ中有两种类型的消费者，Push和Pull，本篇文章将分析RocketMQ DefaultPushConsumer源码" />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="吴昊, Eric Wu, 吴昊的博客, Eric&#39;s Blog, 博客, 个人网站, 互联网, Web, 云原生, PaaS, Istio, Kubernetes, 微服务, Microservice">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>RocketMQ源码分析（一）—— DefaultPushConsumer | 吴昊的博客 | Eric&#39;s Blog</title>

    <link rel="canonical" href="/post/mq_push_consumer/">

    
    
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hugo-theme-cleanwhite.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">

    
    <link href="https://cdn.jsdelivr.net/gh/FortAwesome/Font-Awesome@5.15.1/css/all.css" rel="stylesheet" type="text/css">

    
    

    
    <script src="/js/jquery.min.js"></script>

    
    <script src="/js/bootstrap.min.js"></script>

    
    <script src="/js/hux-blog.min.js"></script>

    
    <script src="/js/lazysizes.min.js"></script>

    
    

</head>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-158682233-1', 'auto');
	
	ga('send', 'pageview');
}
</script>





<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Eric&#39;s Blog</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">All Posts</a>
                    </li>
                    
                        
                        <li>
                            <a href="/categories/java">java</a>
                        </li>
                        
                        <li>
                            <a href="/categories/jvm">jvm</a>
                        </li>
                        
                        <li>
                            <a href="/categories/linux">linux</a>
                        </li>
                        
                        <li>
                            <a href="/categories/mysql">mysql</a>
                        </li>
                        
                        <li>
                            <a href="/categories/os">os</a>
                        </li>
                        
                        <li>
                            <a href="/categories/redis">redis</a>
                        </li>
                        
                        <li>
                            <a href="/categories/spring">spring</a>
                        </li>
                        
                        <li>
                            <a href="/categories/trival">trival</a>
                        </li>
                        
                        <li>
                            <a href="/categories/trivial">trivial</a>
                        </li>
                        
                        <li>
                            <a href="/categories/%E7%AE%97%E6%B3%95">算法</a>
                        </li>
                        
                        <li>
                            <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C">计算机网络</a>
                        </li>
                        
                        <li>
                            <a href="/categories/%E9%9A%8F%E7%AC%94">随笔</a>
                        </li>
                        
                    
                    
		    
                        <li><a href="/top/about/">ABOUT</a></li>
                    
		            <li>
                        <a href="/search"><i class="fa fa-search"></i></a>
		           </li>
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('/img/roof.jpg')
    }
</style>

<header class="intro-header" >

    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90" title="源码分析">
                            源码分析
                        </a>
                        
                    </div>
                    <h1>RocketMQ源码分析（一）—— DefaultPushConsumer</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        
                            Posted by 
                            
                                     &#34;Eric&#34;
                             
                            on 
                            Sunday, February 12, 2023
                            
                            
                            
                            
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                
                <p>RocketMQ中有两类消费者——Push和Pull。Push指的是服务端主动推送消息给客户端，及时性好。RocketMQ的Push消费者类是DefaultMQPushConsumer。但在RocketMQ中，其实际是一种伪Push的方式，因为客户端底层实现仍然是使用Pull的方式将消息从服务器拉取到客户端，然后由消费线程进行消费。Push模式是对Pull模式的封装，类似于一个高级API。</p>
<p>本文将以MQ的标准Push Consumer——DefaultMQPushConsumer为例，进行源码分析。</p>
<h2 id="1-整体结构">1. 整体结构</h2>
<p>
  <img src="https://raw.githubusercontent.com/ericwu0930/picture_host/main/image-20230212201957443.png" alt="image-20230212201957443">

</p>
<h3 id="11-defaultmqpushconsumer核心参数">1.1 DefaultMQPushConsumer核心参数</h3>
<p>DefaultMQPushConsumer的整体框架如上图所示，其中DefaultMQPushConsumer是门面，它提供了可以操作的API接口以及可以修改的属性。具体逻辑都写在实现类DefaultMQPushConsumerImpl。DefaultMQPushConsumer的核心参数如下:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// 这个是消费者一个 final 的属性，用来记录 RocketMQ Consumer 在运作过程中的一些日志，其日志文件默认路径为 `${user.home}/logs/rocketmqlogs/rocketmq_cliente.log`。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>InternalLogger log
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 消费组的名称，在 RocketMQ 中，对于消费中来说，一个消费组就是一个独立的隔离单位，例如多个消费组订阅同一个主题，其消息进度（消息处理的进展）是相互独立的，两者不会有任何的干扰。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>String consumerGroup
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 消息组消息消费模式，在 RocketMQ 中支持集群模式、广播模式。集群模式值得是一个消费组内多个消费者共同消费一个 Topic 中的消息，即一条消息只会被集群内的某一个消费者处理；而广播模式是指一个消费组内的每一个消费者负责 Topic 中的所有消息。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>MessageModel messageModel
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 一个消费者初次启动时（即消费进度管理器中无法查询到该消费组的进度）时从哪个位置开始消费的策略
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>ConsumeFromWhere consumeFromWhere
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 指定从什么时间戳开始消费，其格式为 yyyyMMddHHmmss，默认值为 30 分钟之前，该参数只在 consumeFromWhere 为 CONSUME_FROM_TIMESTAMP 时生效。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>String consumeTimestamp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 消息队列负载策略
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>AllocateMessageQueueStrategy allocateMessageQueueStrategy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 一致性 Hash 算法。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>AllocateMessageQueueConsistentHash
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 消息进度存储管理器，该属性为私有属性，不能通过 API 进行修改，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>OffsetStore offsetStore
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 消费者每一个消费组线程池中最小的线程数量，默认为 20。在 RocketMQ 消费者中，会为每一个消费者创建一个独立的线程池。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> consumeThreadMin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 消费者最大线程数量，在当前的 RocketMQ 版本中，该参数通常与 consumeThreadMin 保持一致，大于没有意义，因为 RocketMQ 创建的线程池内部创建的队列为一个无界队列。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> consumeThreadMax
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 并发消息消费时处理队列中最大偏移量与最小偏移量的差值的阔值，如差值超过该值，触发消费端限流。限流的具体做法是不再向 Broker 拉取该消息队列中的消息，默认值为 2000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> consumeConcurrentlyMaxSpan
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 消费端允许消费端端单队列积压的消息数量，如果处理队列中超过该值，会触发消息消费端的限流。默认值为 1000，不建议修改该值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> pullThresholdForQueue
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 消费端允许消费端但队列中挤压的消息体大小，默认为 100MB
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>pullThresholdSizeForQueue
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 按 Topic 级别进行消息数量限流，默认不开启，为 -1，如果设置该值，会使用该值除以分配给当前消费者的队列数，得到每个消息消费队列的消息阔值，从而改变 pullThresholdForQueue
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>pullThresholdForTopic
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 按 Topic 级别进行消息消息体大小进行限流，默认不开启，其最终通过改变 pullThresholdSizeForQueue 达到限流效果
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>pullThresholdSizeForTopic
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 消息拉取的间隔，默认 0 表示，消息客户端在拉取一批消息提交到线程池后立即向服务端拉取下一批，PUSH 模式不建议修改该值。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">long</span> pullInterval <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 一次消息拉取请求最多从 Broker 返回的消息条数，默认为 32。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> pullBatchSize <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 消息消费一次最大消费的消息条数，这个值得是下图中参数 `ist&lt;MessageExt&gt; msgs` 中消息的最大条数。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> consumeMessageBatchMaxSize 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 消息消费重试次数，并发消费模式下默认重试 16 次后进入到死信队列，如果是顺序消费，重试次数为 Integer.MAX_VALUE。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> maxReconsumeTimes 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 消费模式为顺序消费时设置每一次重试的间隔时间，提高重试成功率。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">long</span> suspendCurrentQueueTimeMillis
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 消息消费超时时间，默认为 15 分钟。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">long</span> consumeTimeout <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>
</span></span></code></pre></div><h3 id="12-mqclientinstance">1.2 MQClientInstance</h3>
<p>DefaultMQPushConsumerImpl中持有MQClientInstance，该类实现了客户端一些通用逻辑，不管是producer还是consumer都内置有这个类，并且一个JVM中所有的消费者、生产者持有同一个MQClientInstance，且MQClientInstance只启动一次。其中有两个Map，producerTable和consumerTable分别用于记录【生产者group：生产者MQProducerInner】和【消费者group：消费者MQConsumerInner】。</p>
<h3 id="13-rebalanceimpl">1.3 RebalanceImpl</h3>
<p>RebalanceImpl会给当前消费者分配对应的MessageQueue。</p>
<h3 id="14-offsetstore">1.4 OffsetStore</h3>
<p>OffsetStore是用来管理Consumer消费位点的接口，该参数主要是根据消费模式在内部自动创建，RocketMQ 在广播消息、集群消费两种模式下分别对应两种OffsetStore——LocalFileOffsetStore和RemoteBrokerOffsetStore，其消息消费进度的存储策略会有所不同：</p>
<ul>
<li>集群模式：RocketMQ 会将消息消费进度存储在 Broker 服务器，存储路径为 <code>${ROCKET_HOME}/store/config/ consumerOffset.json</code> 文件中。</li>
<li>广播模式：RocketMQ 会将消息消费进存在在消费端所在的机器上，存储路径为 <code>${user.home}/.rocketmq_offsets</code> 中。</li>
</ul>
<p>consumerOffset.json文件如下所示，使用 topic@consumerGroup 为键，其值是一个 Map，键为 Topic 的队列序列，值为当前的消息消费位点。</p>
<p>
  <img src="https://raw.githubusercontent.com/ericwu0930/picture_host/main/20200814230847619.png" alt="20200814230847619">

</p>
<p>举例，订阅dw_test这个topic的order_topic_activity_consumer消费组的消费情况如下：该topic有四个队列，其中0号队列消费到了2,1号队列消费到了0,2号队列消费到了0,3号队列消费到了3。</p>
<p>可见，topic和消费组唯一的确定一个消费进度。</p>
<h3 id="15-consumemessageservice">1.5 ConsumeMessageService</h3>
<p>ConsumeMessageService维护有多个线程池，与具体的消息消费有关。</p>
<h3 id="16-servicethread">1.6 ServiceThread</h3>
<p>PullMessageService和RebalanceService都继承了ServiceThread这个抽象类，而ServiceThread又实现了Runnable方法，因此这两个Service可以理解为都是后台线程方法。</p>
<h2 id="2-源码分析">2. 源码分析</h2>
<h3 id="21-使用样例">2.1 使用样例</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 设置消费组
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    DefaultMQPushConsumer defaultMQPushConsumer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> DefaultMQPushConsumer<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ORDER_RESULT_NOTIFY_GROUP&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 设置名字发现服务地址
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    defaultMQPushConsumer<span style="color:#f92672">.</span><span style="color:#a6e22e">setNamesrvAddr</span><span style="color:#f92672">(</span>nameSrvAddr<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 从头开始消费
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    defaultMQPushConsumer<span style="color:#f92672">.</span><span style="color:#a6e22e">setConsumeFromWhere</span><span style="color:#f92672">(</span>ConsumeFromWhere<span style="color:#f92672">.</span><span style="color:#a6e22e">CONSUME_FROM_FIRST_OFFSET</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 消费模式:集群模式
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    defaultMQPushConsumer<span style="color:#f92672">.</span><span style="color:#a6e22e">setMessageModel</span><span style="color:#f92672">(</span>MessageModel<span style="color:#f92672">.</span><span style="color:#a6e22e">CLUSTERING</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 注册监听器
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    defaultMQPushConsumer<span style="color:#f92672">.</span><span style="color:#a6e22e">registerMessageListener</span><span style="color:#f92672">(</span>messageListener<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 订阅所有消息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        defaultMQPushConsumer<span style="color:#f92672">.</span><span style="color:#a6e22e">subscribe</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ORDER_RESULT_NOTIFY_TOPIC&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;*&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        defaultMQPushConsumer<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>MQClientException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;[订单结果通知消息消费者]--NotifySendConsumer加载异常!&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;[订单结果通知消息消费者]--NotifySendConsumer加载完成!&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="22-订阅topic">2.2 订阅Topic</h3>
<p>topic订阅主要通过subscribe实现，首先看下DefaultMQPushConsumer的subscribe实现</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">subscribe</span><span style="color:#f92672">(</span>String topic<span style="color:#f92672">,</span> String subExpression<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> MQClientException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumerImpl</span><span style="color:#f92672">.</span><span style="color:#a6e22e">subscribe</span><span style="color:#f92672">(</span>withNamespace<span style="color:#f92672">(</span>topic<span style="color:#f92672">),</span> subExpression<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>可见其内部是调用了DefaultMQPushConsumerImpl的subscribe方法。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">subscribe</span><span style="color:#f92672">(</span>String topic<span style="color:#f92672">,</span> String subExpression<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> MQClientException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    SubscriptionData subscriptionData <span style="color:#f92672">=</span> FilterAPI<span style="color:#f92672">.</span><span style="color:#a6e22e">buildSubscriptionData</span><span style="color:#f92672">(</span>topic<span style="color:#f92672">,</span> subExpression<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">rebalanceImpl</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getSubscriptionInner</span><span style="color:#f92672">().</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>topic<span style="color:#f92672">,</span> subscriptionData<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mQClientFactory</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 发送心跳信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mQClientFactory</span><span style="color:#f92672">.</span><span style="color:#a6e22e">sendHeartbeatToAllBrokerWithLock</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> MQClientException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;subscription exception&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>可见其首先生成SubscriptionData，这是一个订阅信息类。然后将该类放入到RebalanceImpl类中的Map——subscrpitionInner。该Map的key是topic name，value是SubscriptionData对象。</p>
<p>然后向集群内所有的Broker发送心跳信息，继续跟踪sendHeartbeatToAllBrokerWithLock方法可见其发送的心跳信息HeartbeatData为:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// 客户端ID
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> String clientID<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 生产者信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> Set<span style="color:#f92672">&lt;</span>ProducerData<span style="color:#f92672">&gt;</span> producerDataSet <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashSet<span style="color:#f92672">&lt;</span>ProducerData<span style="color:#f92672">&gt;();</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 消费者信息, 包含订阅信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> Set<span style="color:#f92672">&lt;</span>ConsumerData<span style="color:#f92672">&gt;</span> consumerDataSet <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashSet<span style="color:#f92672">&lt;</span>ConsumerData<span style="color:#f92672">&gt;();</span>
</span></span></code></pre></div><p>其中ConsumerData即为消费者的信息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> String groupName<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> ConsumeType consumeType<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> MessageModel messageModel<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> ConsumeFromWhere consumeFromWhere<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 订阅信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> Set<span style="color:#f92672">&lt;</span>SubscriptionData<span style="color:#f92672">&gt;</span> subscriptionDataSet <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashSet<span style="color:#f92672">&lt;</span>SubscriptionData<span style="color:#f92672">&gt;();</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> unitMode<span style="color:#f92672">;</span>
</span></span></code></pre></div><p>在MQClientInstance类中，HeatbeatData信息的生成方法prepareHeartbeatData</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> HeartbeatData <span style="color:#a6e22e">prepareHeartbeatData</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  HeartbeatData heartbeatData <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HeartbeatData<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// clientID
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  heartbeatData<span style="color:#f92672">.</span><span style="color:#a6e22e">setClientID</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">clientId</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Consumer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Map<span style="color:#f92672">.</span><span style="color:#a6e22e">Entry</span><span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> MQConsumerInner<span style="color:#f92672">&gt;</span> entry <span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">consumerTable</span><span style="color:#f92672">.</span><span style="color:#a6e22e">entrySet</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    MQConsumerInner impl <span style="color:#f92672">=</span> entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getValue</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>impl <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      ConsumerData consumerData <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConsumerData<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>      consumerData<span style="color:#f92672">.</span><span style="color:#a6e22e">setGroupName</span><span style="color:#f92672">(</span>impl<span style="color:#f92672">.</span><span style="color:#a6e22e">groupName</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>      consumerData<span style="color:#f92672">.</span><span style="color:#a6e22e">setConsumeType</span><span style="color:#f92672">(</span>impl<span style="color:#f92672">.</span><span style="color:#a6e22e">consumeType</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>      consumerData<span style="color:#f92672">.</span><span style="color:#a6e22e">setMessageModel</span><span style="color:#f92672">(</span>impl<span style="color:#f92672">.</span><span style="color:#a6e22e">messageModel</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>      consumerData<span style="color:#f92672">.</span><span style="color:#a6e22e">setConsumeFromWhere</span><span style="color:#f92672">(</span>impl<span style="color:#f92672">.</span><span style="color:#a6e22e">consumeFromWhere</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>      consumerData<span style="color:#f92672">.</span><span style="color:#a6e22e">getSubscriptionDataSet</span><span style="color:#f92672">().</span><span style="color:#a6e22e">addAll</span><span style="color:#f92672">(</span>impl<span style="color:#f92672">.</span><span style="color:#a6e22e">subscriptions</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>      consumerData<span style="color:#f92672">.</span><span style="color:#a6e22e">setUnitMode</span><span style="color:#f92672">(</span>impl<span style="color:#f92672">.</span><span style="color:#a6e22e">isUnitMode</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      heartbeatData<span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumerDataSet</span><span style="color:#f92672">().</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>consumerData<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Producer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Map<span style="color:#f92672">.</span><span style="color:#a6e22e">Entry</span><span style="color:#f92672">&lt;</span>String<span style="color:#75715e">/* group */</span><span style="color:#f92672">,</span> MQProducerInner<span style="color:#f92672">&gt;</span> entry <span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">producerTable</span><span style="color:#f92672">.</span><span style="color:#a6e22e">entrySet</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    MQProducerInner impl <span style="color:#f92672">=</span> entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getValue</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>impl <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      ProducerData producerData <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ProducerData<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>      producerData<span style="color:#f92672">.</span><span style="color:#a6e22e">setGroupName</span><span style="color:#f92672">(</span>entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getKey</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>      heartbeatData<span style="color:#f92672">.</span><span style="color:#a6e22e">getProducerDataSet</span><span style="color:#f92672">().</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>producerData<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> heartbeatData<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>可见其是通过consumerTable和producerTable分别映射到MQConsumerInner以及MQProducerInner，然后拿到相关的配置，生成heartbeatData。</p>
<p>我们继续看看 broker 如何处理 HeartbeatData 数据，客户端发送 HeartbeatData 时的请求类型为 HEART_BEAT，我们直接找到 broker 处理 HEART_BEAT 请求类型的逻辑：</p>
<p>org.apache.rocketmq.broker.processor.ClientManageProcessor#heartBeat：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> RemotingCommand <span style="color:#a6e22e">heartBeat</span><span style="color:#f92672">(</span>ChannelHandlerContext ctx<span style="color:#f92672">,</span> RemotingCommand request<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  RemotingCommand response <span style="color:#f92672">=</span> RemotingCommand<span style="color:#f92672">.</span><span style="color:#a6e22e">createResponseCommand</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 解码获得心跳信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  HeartbeatData heartbeatData <span style="color:#f92672">=</span> HeartbeatData<span style="color:#f92672">.</span><span style="color:#a6e22e">decode</span><span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">getBody</span><span style="color:#f92672">(),</span> HeartbeatData<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  ClientChannelInfo clientChannelInfo <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ClientChannelInfo<span style="color:#f92672">(</span>ctx<span style="color:#f92672">.</span><span style="color:#a6e22e">channel</span><span style="color:#f92672">(),</span>heartbeatData<span style="color:#f92672">.</span><span style="color:#a6e22e">getClientID</span><span style="color:#f92672">(),</span>
</span></span><span style="display:flex;"><span>            request<span style="color:#f92672">.</span><span style="color:#a6e22e">getLanguage</span><span style="color:#f92672">(),</span>
</span></span><span style="display:flex;"><span>            request<span style="color:#f92672">.</span><span style="color:#a6e22e">getVersion</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 循环注册消费者信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>ConsumerData data <span style="color:#f92672">:</span> heartbeatData<span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumerDataSet</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 按消费组得到订阅信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    SubscriptionGroupConfig subscriptionGroupConfig <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">brokerController</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getSubscriptionGroupManager</span><span style="color:#f92672">().</span><span style="color:#a6e22e">findSubscriptionGroupConfig</span><span style="color:#f92672">(</span>data<span style="color:#f92672">.</span><span style="color:#a6e22e">getGroupName</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">boolean</span> isNotifyConsumerIdsChangedEnable <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">null</span> <span style="color:#f92672">!=</span> subscriptionGroupConfig<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      isNotifyConsumerIdsChangedEnable <span style="color:#f92672">=</span> subscriptionGroupConfig<span style="color:#f92672">.</span><span style="color:#a6e22e">isNotifyConsumerIdsChangedEnable</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> topicSysFlag <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>data<span style="color:#f92672">.</span><span style="color:#a6e22e">isUnitMode</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        topicSysFlag <span style="color:#f92672">=</span> TopicSysFlag<span style="color:#f92672">.</span><span style="color:#a6e22e">buildSysFlag</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      String newTopic <span style="color:#f92672">=</span> MixAll<span style="color:#f92672">.</span><span style="color:#a6e22e">getRetryTopic</span><span style="color:#f92672">(</span>data<span style="color:#f92672">.</span><span style="color:#a6e22e">getGroupName</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">brokerController</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getTopicConfigManager</span><span style="color:#f92672">().</span><span style="color:#a6e22e">createTopicInSendMessageBackMethod</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>        newTopic<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>        subscriptionGroupConfig<span style="color:#f92672">.</span><span style="color:#a6e22e">getRetryQueueNums</span><span style="color:#f92672">(),</span>
</span></span><span style="display:flex;"><span>        PermName<span style="color:#f92672">.</span><span style="color:#a6e22e">PERM_WRITE</span> <span style="color:#f92672">|</span> PermName<span style="color:#f92672">.</span><span style="color:#a6e22e">PERM_READ</span><span style="color:#f92672">,</span> topicSysFlag<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 注册消费者订阅信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">boolean</span> changed <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">brokerController</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumerManager</span><span style="color:#f92672">().</span><span style="color:#a6e22e">registerConsumer</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>      data<span style="color:#f92672">.</span><span style="color:#a6e22e">getGroupName</span><span style="color:#f92672">(),</span>
</span></span><span style="display:flex;"><span>      clientChannelInfo<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>      data<span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumeType</span><span style="color:#f92672">(),</span>
</span></span><span style="display:flex;"><span>      data<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageModel</span><span style="color:#f92672">(),</span>
</span></span><span style="display:flex;"><span>      data<span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumeFromWhere</span><span style="color:#f92672">(),</span>
</span></span><span style="display:flex;"><span>      data<span style="color:#f92672">.</span><span style="color:#a6e22e">getSubscriptionDataSet</span><span style="color:#f92672">(),</span>
</span></span><span style="display:flex;"><span>      isNotifyConsumerIdsChangedEnable
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 注册生产者订阅信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  response<span style="color:#f92672">.</span><span style="color:#a6e22e">setCode</span><span style="color:#f92672">(</span>ResponseCode<span style="color:#f92672">.</span><span style="color:#a6e22e">SUCCESS</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  response<span style="color:#f92672">.</span><span style="color:#a6e22e">setRemark</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> response<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>org.apache.rocketmq.broker.client.ConsumerManager#registerConsumer：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">registerConsumer</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> String group<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> ClientChannelInfo clientChannelInfo<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>        ConsumeType consumeType<span style="color:#f92672">,</span> MessageModel messageModel<span style="color:#f92672">,</span> ConsumeFromWhere consumeFromWhere<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> Set<span style="color:#f92672">&lt;</span>SubscriptionData<span style="color:#f92672">&gt;</span> subList<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> isNotifyConsumerIdsChangedEnable<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 得到消费组内的消费者信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  ConsumerGroupInfo consumerGroupInfo <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">consumerTable</span><span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>group<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 如果消费组的消费者信息为空，则新建一个
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">null</span> <span style="color:#f92672">==</span> consumerGroupInfo<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    ConsumerGroupInfo tmp <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConsumerGroupInfo<span style="color:#f92672">(</span>group<span style="color:#f92672">,</span> consumeType<span style="color:#f92672">,</span> messageModel<span style="color:#f92672">,</span> consumeFromWhere<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    ConsumerGroupInfo prev <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">consumerTable</span><span style="color:#f92672">.</span><span style="color:#a6e22e">putIfAbsent</span><span style="color:#f92672">(</span>group<span style="color:#f92672">,</span> tmp<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    consumerGroupInfo <span style="color:#f92672">=</span> prev <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> prev <span style="color:#f92672">:</span> tmp<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">boolean</span> r1 <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    consumerGroupInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">updateChannel</span><span style="color:#f92672">(</span>clientChannelInfo<span style="color:#f92672">,</span> consumeType<span style="color:#f92672">,</span> messageModel<span style="color:#f92672">,</span>consumeFromWhere<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 更新订阅信息，订阅信息是按照消费组存放的，因此这步骤就会导致同一个消费组内的各个消费者客户端的订阅信息相互被覆盖
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">boolean</span> r2 <span style="color:#f92672">=</span> consumerGroupInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">updateSubscription</span><span style="color:#f92672">(</span>subList<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r1 <span style="color:#f92672">||</span> r2<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isNotifyConsumerIdsChangedEnable<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">consumerIdsChangeListener</span><span style="color:#f92672">.</span><span style="color:#a6e22e">handle</span><span style="color:#f92672">(</span>ConsumerGroupEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">CHANGE</span><span style="color:#f92672">,</span> group<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                                            consumerGroupInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">getAllChannel</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">consumerIdsChangeListener</span><span style="color:#f92672">.</span><span style="color:#a6e22e">handle</span><span style="color:#f92672">(</span>ConsumerGroupEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">REGISTER</span><span style="color:#f92672">,</span> group<span style="color:#f92672">,</span> subList<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> r1 <span style="color:#f92672">||</span> r2<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>这步骤是 Broker 更新消费者订阅信息的核心方法，如果消费组的消费者信息 ConsumerGroupInfo 为空，则新建一个，从名字可知道，订阅信息是按照消费组进行存放的，<strong>因此在更新订阅信息时，订阅信息是按照消费组存放的，这步骤就会导致同一个消费组内的各个消费者客户端的订阅信息相互被覆盖</strong>。</p>
<h3 id="23-启动消费客户端">2.3 启动消费客户端</h3>
<p>在DefaultMQPushConsumer初始化完成后，通过start()方法启动客户端，追到DefaultMQPushConsumerImpl.start()方法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">start</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> MQClientException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">serviceState</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> CREATE_JUST<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 初始化MQClientInstance，如果已经存在直接使用存在的MQClientInstance
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mQClientFactory</span> <span style="color:#f92672">=</span> MQClientManager<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">.</span><span style="color:#a6e22e">getOrCreateMQClientInstance</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">rpcHook</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 为消费者负载均衡rebalanceImpl设置属性
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// 1. 设置消费组
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">rebalanceImpl</span><span style="color:#f92672">.</span><span style="color:#a6e22e">setConsumerGroup</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumerGroup</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 2. 设置消费模式
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">rebalanceImpl</span><span style="color:#f92672">.</span><span style="color:#a6e22e">setMessageModel</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageModel</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 3. 设置rebalance策略
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">rebalanceImpl</span><span style="color:#f92672">.</span><span style="color:#a6e22e">setAllocateMessageQueueStrategy</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getAllocateMessageQueueStrategy</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 4. 设置当前MQClientInstance实例
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">rebalanceImpl</span><span style="color:#f92672">.</span><span style="color:#a6e22e">setmQClientFactory</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mQClientFactory</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">pullAPIWrapper</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PullAPIWrapper<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>              mQClientFactory<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumerGroup</span><span style="color:#f92672">(),</span> isUnitMode<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">pullAPIWrapper</span><span style="color:#f92672">.</span><span style="color:#a6e22e">registerFilterMessageHook</span><span style="color:#f92672">(</span>filterMessageHookList<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getOffsetStore</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">offsetStore</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getOffsetStore</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">// 不同消息模式OffsetStore不一样
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageModel</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>              <span style="color:#75715e">// 广播模式，使用本地存储方式
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>              <span style="color:#66d9ef">case</span> BROADCASTING<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">offsetStore</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LocalFileOffsetStore<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mQClientFactory</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                          <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumerGroup</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#75715e">// 集群模式，使用远端Broker存储方式存储offset
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>              <span style="color:#66d9ef">case</span> CLUSTERING<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">offsetStore</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RemoteBrokerOffsetStore<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mQClientFactory</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                          <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumerGroup</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">setOffsetStore</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">offsetStore</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 加载当前的offset
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">offsetStore</span><span style="color:#f92672">.</span><span style="color:#a6e22e">load</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 根据Listener的不同选择不同的ConsumeMessageService，分为顺序消息消费服务和并行消息消费服务
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageListenerInner</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">instanceof</span> MessageListenerOrderly<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">consumeOrderly</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">consumeMessageService</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#66d9ef">new</span> ConsumeMessageOrderlyService<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                          <span style="color:#f92672">(</span>MessageListenerOrderly<span style="color:#f92672">)</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageListenerInner</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageListenerInner</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">instanceof</span> MessageListenerConcurrently<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">consumeOrderly</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">consumeMessageService</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConsumeMessageConcurrentlyService<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                          <span style="color:#f92672">(</span>MessageListenerConcurrently<span style="color:#f92672">)</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageListenerInner</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 启动ConsumeMessageService
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">consumeMessageService</span><span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 向MQClientInstance中注册消费者，并启动MQClientInstance
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">boolean</span> registerOK <span style="color:#f92672">=</span> mQClientFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">registerConsumer</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumerGroup</span><span style="color:#f92672">(),</span>
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>registerOK<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">serviceState</span> <span style="color:#f92672">=</span> ServiceState<span style="color:#f92672">.</span><span style="color:#a6e22e">CREATE_JUST</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">consumeMessageService</span><span style="color:#f92672">.</span><span style="color:#a6e22e">shutdown</span><span style="color:#f92672">(</span>defaultMQPushConsumer<span style="color:#f92672">.</span><span style="color:#a6e22e">getAwaitTerminationMillisWhenShutdown</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> MQClientException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;The consumer group[&#34;</span> <span style="color:#f92672">+</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumerGroup</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;] has been created before, specify another name please.&#34;</span> <span style="color:#f92672">+</span> FAQUrl<span style="color:#f92672">.</span><span style="color:#a6e22e">suggestTodo</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                  FAQUrl<span style="color:#f92672">.</span><span style="color:#a6e22e">GROUP_NAME_DUPLICATE_URL</span><span style="color:#f92672">),</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      mQClientFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>      log<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;the consumer [{}] start OK.&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumerGroup</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">serviceState</span> <span style="color:#f92672">=</span> ServiceState<span style="color:#f92672">.</span><span style="color:#a6e22e">RUNNING</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>整个DefaultMQPushConsumer的启动以及消费流程课件下图所示，</p>
<p>
  <img src="https://raw.githubusercontent.com/ericwu0930/picture_host/main/20200814230940226.png" alt="7">

</p>
<ol>
<li>经过队列负载机制后，会分配给当前消费者一些队列，注意一个消费组可以订阅多个主题，正如上面 pullRequestQueue 中所示，topic_test、topic_test1 这两个主题都分配了一个队列。</li>
<li>轮流从 pullRequestQueue 中取出一个 PullRequest 对象，根据该对象中的拉取偏移量向 Broker 发起拉取请求，默认拉取 32 条，可通过上文中提到的DefaultMQPushConsumer中的pullBatchSize 参数进行改变，该方法不仅会返回消息列表，还会返更改 PullRequest 对象中的下一次拉取的偏移量。</li>
<li>接收到 Broker 返回的消息后，会首先放入 ProccessQueue，该对象内部持有一个 TreeMap，key 存放的是消息在消息消费队列（consume queue）中的偏移量（offset），而 value 为具体的消息对象(MessageExt)。</li>
<li>然后将拉取到的消息提交到消费组内部的线程池，并立即返回，并将 PullRequest 对象放入到 pullRequestQueue 中，然后取出下一个 PullRequest 对象继续重复消息拉取的流程，从这里可以看出，消息拉取与消息消费是不同的线程。</li>
<li>消息消费组线程池处理完一条消息后，会将消息从 ProccessQueue 中，然后会向 Broker 汇报消息消费进度，以便下次重启时能从上一次消费的位置开始消费。</li>
</ol>
<p>在了解完DefaultMQPushConsumer整体的消费流程后，下面分析各个类的源码。</p>
<h3 id="24-mqclientinstance类">2.4 MQClientInstance类</h3>
<p>在初始化MQClientInstance对象的时候，在其构造方法中会构建PullMessageService类和RebalanceService类。</p>
<p>PullMessageService类和RebalanceService类都可以视为后台线程类，在MQClientInstance对象的start方法中也都会分别新建线程去运行这两个类的run方法。RebalanceService暂且不表，下面先介绍下跟消费者主流程有关的PullMessageService。</p>
<h3 id="25-pullmessageservice">2.5 PullMessageService</h3>
<p>PullMessageService的run方法如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#f92672">(!</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isStopped</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// pullRequest在RebalanceImpl中创建
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            PullRequest pullRequest <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">pullRequestQueue</span><span style="color:#f92672">.</span><span style="color:#a6e22e">take</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">pullMessage</span><span style="color:#f92672">(</span>pullRequest<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException ignored<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            log<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Pull Message Service Run Method exception&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>可见在该方法中会不断从pullRequestQueue中拿PullRequest，如果拿不到会阻塞；如果拿到，则调用pullMessage方法。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">pullMessage</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> PullRequest pullRequest<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 从MQClientInstance中根据消费组得到该消费组的ConsumerImpl
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">final</span> MQConsumerInner consumer <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mQClientFactory</span><span style="color:#f92672">.</span><span style="color:#a6e22e">selectConsumer</span><span style="color:#f92672">(</span>pullRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumerGroup</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>consumer <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    DefaultMQPushConsumerImpl impl <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>DefaultMQPushConsumerImpl<span style="color:#f92672">)</span> consumer<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 执行ConsumerImpl的pullMessage方法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    impl<span style="color:#f92672">.</span><span style="color:#a6e22e">pullMessage</span><span style="color:#f92672">(</span>pullRequest<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>其中PullRequest有如下所示属性：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// 消费组
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> String consumerGroup<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 消费队列相关信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> MessageQueue messageQueue<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 消费队列的本地缓存，其中包含msgTreeMap:TreeMap&lt;Long,MessageExt&gt;, key为offset
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> ProcessQueue processQueue<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">long</span> nextOffset<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> previouslyLocked <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span></code></pre></div><p>接着我们看DefaultMQPushConsumerImpl中的pullMessage方法，该方法从Broker中拉取一定数量的消息到本地的ProcessQueue中，我将该方法分为三部分(超长代码预警)</p>
<p>第一部分是限流逻辑，即代码中的QueueFlowControl，在触发限流后会将pullRequest延缓一定时间，然后放回到PullMessageService的pullRequestQueue中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">final</span> ProcessQueue processQueue <span style="color:#f92672">=</span> pullRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getProcessQueue</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 设置当前拉取消息的时间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>pullRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getProcessQueue</span><span style="color:#f92672">().</span><span style="color:#a6e22e">setLastPullTimestamp</span><span style="color:#f92672">(</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 以下代码都触发了限流逻辑, 我们称之为Queue flow control
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 1. 如果暂停了，则将pullRequest延迟一定时间后再次放回到PullMessageService的pullRequestQueue中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isPause</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">executePullRequestLater</span><span style="color:#f92672">(</span>pullRequest<span style="color:#f92672">,</span> PULL_TIME_DELAY_MILLS_WHEN_SUSPEND<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 缓存的消息数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">long</span> cachedMessageCount <span style="color:#f92672">=</span> processQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">getMsgCount</span><span style="color:#f92672">().</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 缓存的容量
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">long</span> cachedMessageSizeInMiB <span style="color:#f92672">=</span> processQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">getMsgSize</span><span style="color:#f92672">().</span><span style="color:#a6e22e">get</span><span style="color:#f92672">()</span> <span style="color:#f92672">/</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">1024</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 2. 如果缓存的消息数已经大于threshold，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 则将pullRequest延迟一定时间后再次返回到PullMessageService的pullRequestQueue中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>cachedMessageCount <span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getPullThresholdForQueue</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">executePullRequestLater</span><span style="color:#f92672">(</span>pullRequest<span style="color:#f92672">,</span> PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 3. 如果缓存的消息容量大于threshold，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 则将pullRequest延迟一定时间后再次返回到PullMessageService的pullRequestQueue中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>cachedMessageSizeInMiB <span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getPullThresholdSizeForQueue</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">executePullRequestLater</span><span style="color:#f92672">(</span>pullRequest<span style="color:#f92672">,</span> PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">consumeOrderly</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// processQueue.getMaxSpan()指的是缓存的消息最大偏移量和最小偏移量之间的差值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// defaultMQPushConsumer.getConsumeConcurrentlyMaxSpan()为这个差值的最大阈值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>processQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">getMaxSpan</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumeConcurrentlyMaxSpan</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">executePullRequestLater</span><span style="color:#f92672">(</span>pullRequest<span style="color:#f92672">,</span> PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 顺序消费逻辑暂时不看
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>接下来是与Broker通讯之前各种准备材料的构造，其中PullCallback方法是在与Broker通讯后需要执行的回调方法。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// 拿到Topic对应的订阅关系
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">final</span> SubscriptionData subscriptionData <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">rebalanceImpl</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getSubscriptionInner</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>pullRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageQueue</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getTopic</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">null</span> <span style="color:#f92672">==</span> subscriptionData<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">executePullRequestLater</span><span style="color:#f92672">(</span>pullRequest<span style="color:#f92672">,</span> pullTimeDelayMillsWhenException<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    log<span style="color:#f92672">.</span><span style="color:#a6e22e">warn</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;find the consumer&#39;s subscription failed, {}&#34;</span><span style="color:#f92672">,</span> pullRequest<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 设置开始拉取的时间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> beginTimestamp <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 处理拉取到消息后的回调逻辑
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>PullCallback pullCallback <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PullCallback<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 请求正常完成
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onSuccess</span><span style="color:#f92672">(</span>PullResult pullResult<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>pullResult <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            pullResult <span style="color:#f92672">=</span> DefaultMQPushConsumerImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">pullAPIWrapper</span><span style="color:#f92672">.</span><span style="color:#a6e22e">processPullResult</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                    pullRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageQueue</span><span style="color:#f92672">(),</span> pullResult<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                    subscriptionData<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75715e">// 拉取结果
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>pullResult<span style="color:#f92672">.</span><span style="color:#a6e22e">getPullStatus</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 拉取到了新消息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">case</span> FOUND<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 从pullRequest中拿到当前拉取消息时候的offset
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">long</span> prevRequestOffset <span style="color:#f92672">=</span> pullRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getNextOffset</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 从pullResult中拿到下一次开始拉取消息的offset，并更新到pullRequest中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    pullRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">setNextOffset</span><span style="color:#f92672">(</span>pullResult<span style="color:#f92672">.</span><span style="color:#a6e22e">getNextBeginOffset</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">long</span> pullRT <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> beginTimestamp<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                    DefaultMQPushConsumerImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumerStatsManager</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">.</span><span style="color:#a6e22e">incPullRT</span><span style="color:#f92672">(</span>pullRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumerGroup</span><span style="color:#f92672">(),</span>
</span></span><span style="display:flex;"><span>                                    pullRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageQueue</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getTopic</span><span style="color:#f92672">(),</span> pullRT<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">long</span> firstMsgOffset <span style="color:#f92672">=</span> Long<span style="color:#f92672">.</span><span style="color:#a6e22e">MAX_VALUE</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                		<span style="color:#75715e">// 如果pullResult中拉取到的消息为null，则立即再拉取一次（容错措施，不应该出现）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>pullResult<span style="color:#f92672">.</span><span style="color:#a6e22e">getMsgFoundList</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> pullResult<span style="color:#f92672">.</span><span style="color:#a6e22e">getMsgFoundList</span><span style="color:#f92672">().</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        DefaultMQPushConsumerImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">executePullRequestImmediately</span><span style="color:#f92672">(</span>pullRequest<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        firstMsgOffset <span style="color:#f92672">=</span> pullResult<span style="color:#f92672">.</span><span style="color:#a6e22e">getMsgFoundList</span><span style="color:#f92672">().</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#ae81ff">0</span><span style="color:#f92672">).</span><span style="color:#a6e22e">getQueueOffset</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        DefaultMQPushConsumerImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumerStatsManager</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#f92672">.</span><span style="color:#a6e22e">incPullTPS</span><span style="color:#f92672">(</span>pullRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumerGroup</span><span style="color:#f92672">(),</span>
</span></span><span style="display:flex;"><span>                                        pullRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageQueue</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getTopic</span><span style="color:#f92672">(),</span>
</span></span><span style="display:flex;"><span>                                        pullResult<span style="color:#f92672">.</span><span style="color:#a6e22e">getMsgFoundList</span><span style="color:#f92672">().</span><span style="color:#a6e22e">size</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        <span style="color:#75715e">// 将拉取到的消息放入到PullRequest的processQueue中的treeMap中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">boolean</span> dispatchToConsume <span style="color:#f92672">=</span> processQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">putMessage</span><span style="color:#f92672">(</span>pullResult<span style="color:#f92672">.</span><span style="color:#a6e22e">getMsgFoundList</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#75715e">// * 提交消费请求
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                        DefaultMQPushConsumerImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">consumeMessageService</span><span style="color:#f92672">.</span><span style="color:#a6e22e">submitConsumeRequest</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                                pullResult<span style="color:#f92672">.</span><span style="color:#a6e22e">getMsgFoundList</span><span style="color:#f92672">(),</span>
</span></span><span style="display:flex;"><span>                                processQueue<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                                pullRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageQueue</span><span style="color:#f92672">(),</span>
</span></span><span style="display:flex;"><span>                                dispatchToConsume<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        <span style="color:#75715e">// 如果DefaultMQPushConsumer设置的PullInterval为0，则立即再从Broker中拉一次消息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                      	<span style="color:#75715e">// 否则，则在制定时间后再次拉消息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DefaultMQPushConsumerImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getPullInterval</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            DefaultMQPushConsumerImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">executePullRequestLater</span><span style="color:#f92672">(</span>pullRequest<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                                   DefaultMQPushConsumerImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getPullInterval</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            DefaultMQPushConsumerImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">executePullRequestImmediately</span><span style="color:#f92672">(</span>pullRequest<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>pullResult<span style="color:#f92672">.</span><span style="color:#a6e22e">getNextBeginOffset</span><span style="color:#f92672">()</span> <span style="color:#f92672">&lt;</span> prevRequestOffset
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">||</span> firstMsgOffset <span style="color:#f92672">&lt;</span> prevRequestOffset<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        log<span style="color:#f92672">.</span><span style="color:#a6e22e">warn</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#e6db74">&#34;[BUG] pull message result maybe data wrong, nextBeginOffset: {} firstMsgOffset: {} prevRequestOffset: {}&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                                pullResult<span style="color:#f92672">.</span><span style="color:#a6e22e">getNextBeginOffset</span><span style="color:#f92672">(),</span>
</span></span><span style="display:flex;"><span>                                firstMsgOffset<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                                prevRequestOffset<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 没有新消息 或 过滤结果后没有匹配的消息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">case</span> NO_NEW_MSG<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">case</span> NO_MATCHED_MSG<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                		<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 非法的offset
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">case</span> OFFSET_ILLEGAL<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    pullRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">setNextOffset</span><span style="color:#f92672">(</span>pullResult<span style="color:#f92672">.</span><span style="color:#a6e22e">getNextBeginOffset</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    pullRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getProcessQueue</span><span style="color:#f92672">().</span><span style="color:#a6e22e">setDropped</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    DefaultMQPushConsumerImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">executeTaskLater</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Runnable<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#75715e">// 更新本地的offset
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                                DefaultMQPushConsumerImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">offsetStore</span><span style="color:#f92672">.</span><span style="color:#a6e22e">updateOffset</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                                        pullRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageQueue</span><span style="color:#f92672">(),</span>
</span></span><span style="display:flex;"><span>                                        pullRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getNextOffset</span><span style="color:#f92672">(),</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#75715e">// 持久化offset，在本地或者到Broker
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                                DefaultMQPushConsumerImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">offsetStore</span><span style="color:#f92672">.</span><span style="color:#a6e22e">persist</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                                        pullRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageQueue</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#75715e">// 将消息队列的缓存移除
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                                DefaultMQPushConsumerImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">rebalanceImpl</span><span style="color:#f92672">.</span><span style="color:#a6e22e">removeProcessQueue</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                                        pullRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageQueue</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                                log<span style="color:#f92672">.</span><span style="color:#a6e22e">warn</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;fix the pull request offset, {}&#34;</span><span style="color:#f92672">,</span> pullRequest<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Throwable e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                                log<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;executeTaskLater Exception&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">},</span> <span style="color:#ae81ff">10000</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 请求出现异常
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onException</span><span style="color:#f92672">(</span>Throwable e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>pullRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageQueue</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getTopic</span><span style="color:#f92672">().</span><span style="color:#a6e22e">startsWith</span><span style="color:#f92672">(</span>MixAll<span style="color:#f92672">.</span><span style="color:#a6e22e">RETRY_GROUP_TOPIC_PREFIX</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            log<span style="color:#f92672">.</span><span style="color:#a6e22e">warn</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;execute the pull request exception&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        DefaultMQPushConsumerImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">executePullRequestLater</span><span style="color:#f92672">(</span>pullRequest<span style="color:#f92672">,</span> pullTimeDelayMillsWhenException<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">boolean</span> commitOffsetEnable <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">long</span> commitOffsetValue <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>L<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 集群模式下从本地读取消息的offset
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>MessageModel<span style="color:#f92672">.</span><span style="color:#a6e22e">CLUSTERING</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageModel</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    commitOffsetValue <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">offsetStore</span><span style="color:#f92672">.</span><span style="color:#a6e22e">readOffset</span><span style="color:#f92672">(</span>pullRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageQueue</span><span style="color:#f92672">(),</span>
</span></span><span style="display:flex;"><span>            ReadOffsetType<span style="color:#f92672">.</span><span style="color:#a6e22e">READ_FROM_MEMORY</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>commitOffsetValue <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        commitOffsetEnable <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>String subExpression <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">boolean</span> classFilter <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>SubscriptionData sd <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">rebalanceImpl</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getSubscriptionInner</span><span style="color:#f92672">().</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>pullRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageQueue</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getTopic</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>sd <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isPostSubscriptionWhenPull</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>sd<span style="color:#f92672">.</span><span style="color:#a6e22e">isClassFilterMode</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        subExpression <span style="color:#f92672">=</span> sd<span style="color:#f92672">.</span><span style="color:#a6e22e">getSubString</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    classFilter <span style="color:#f92672">=</span> sd<span style="color:#f92672">.</span><span style="color:#a6e22e">isClassFilterMode</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> sysFlag <span style="color:#f92672">=</span> PullSysFlag<span style="color:#f92672">.</span><span style="color:#a6e22e">buildSysFlag</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>        commitOffsetEnable<span style="color:#f92672">,</span> <span style="color:#75715e">// commitOffset
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> <span style="color:#75715e">// suspend
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        subExpression <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#75715e">// subscription
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        classFilter <span style="color:#75715e">// class filter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">);</span>
</span></span></code></pre></div><p>最后调用API，从Broker拉取消息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">pullAPIWrapper</span><span style="color:#f92672">.</span><span style="color:#a6e22e">pullKernelImpl</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>            pullRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageQueue</span><span style="color:#f92672">(),</span>
</span></span><span style="display:flex;"><span>            subExpression<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            subscriptionData<span style="color:#f92672">.</span><span style="color:#a6e22e">getExpressionType</span><span style="color:#f92672">(),</span>
</span></span><span style="display:flex;"><span>            subscriptionData<span style="color:#f92672">.</span><span style="color:#a6e22e">getSubVersion</span><span style="color:#f92672">(),</span>
</span></span><span style="display:flex;"><span>      			<span style="color:#75715e">// 下一个offset
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            pullRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getNextOffset</span><span style="color:#f92672">(),</span>
</span></span><span style="display:flex;"><span>      			<span style="color:#75715e">// 拉取的消息数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getPullBatchSize</span><span style="color:#f92672">(),</span>
</span></span><span style="display:flex;"><span>            sysFlag<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>      			<span style="color:#75715e">// 已提交的offset
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            commitOffsetValue<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            BROKER_SUSPEND_MAX_TIME_MILLIS<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            CONSUMER_TIMEOUT_MILLIS_WHEN_SUSPEND<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            CommunicationMode<span style="color:#f92672">.</span><span style="color:#a6e22e">ASYNC</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>      			<span style="color:#75715e">// 拉取消息后，回调逻辑
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            pullCallback
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    log<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;pullKernelImpl exception&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">executePullRequestLater</span><span style="color:#f92672">(</span>pullRequest<span style="color:#f92672">,</span> pullTimeDelayMillsWhenException<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="26-consumemessageservice">2.6 ConsumeMessageService</h3>
<p>在客户端启动过程中，会根据注册的Listener的类型，选择初始化ConsumeMessageConcurrentlyService或者ConsumeMessageOrderlyService，然后执行其start方法。</p>
<p>以ConsumeMessageConcurrentlyService为例，其在start方法只是定期清理过期消息，不是很重要。核心逻辑在其构造方法中，可见初始化了三个线程池。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ConsumeMessageConcurrentlyService</span><span style="color:#f92672">(</span>DefaultMQPushConsumerImpl defaultMQPushConsumerImpl<span style="color:#f92672">,</span>MessageListenerConcurrently messageListener<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumerImpl</span> <span style="color:#f92672">=</span> defaultMQPushConsumerImpl<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">messageListener</span> <span style="color:#f92672">=</span> messageListener<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumerImpl</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getDefaultMQPushConsumer</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">consumerGroup</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumerGroup</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 初始化消费请求队列为LinkedBlockingQueue无界队列
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">consumeRequestQueue</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LinkedBlockingQueue<span style="color:#f92672">&lt;</span>Runnable<span style="color:#f92672">&gt;();</span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>  	<span style="color:#75715e">// 线程名
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    String consumeThreadPrefix <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>consumerGroup<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">100</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      consumeThreadPrefix <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StringBuilder<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ConsumeMessageThread_&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>consumerGroup<span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">,</span><span style="color:#ae81ff">100</span><span style="color:#f92672">).</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;_&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      consumeThreadPrefix <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StringBuilder<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ConsumeMessageThread_&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>consumerGroup<span style="color:#f92672">).</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;_&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 初始化线程池,指向消费调度线程池
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 最小线程数为consumeThreadMin
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 最大线程数为consumeThreadMax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 队列为this.consumeRequestQueue, 即一个无界阻塞队列，因此线程数取决于consumeThreadMin
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  	<span style="color:#75715e">// 线程名为上段设置的consumeThreadPrefix
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">consumeExecutor</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ThreadPoolExecutor<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumeThreadMin</span><span style="color:#f92672">(),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumeThreadMax</span><span style="color:#f92672">(),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">1000</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            TimeUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">MILLISECONDS</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">consumeRequestQueue</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> ThreadFactoryImpl<span style="color:#f92672">(</span>consumeThreadPrefix<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 初始化消费定时任务线程池，线程数=1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">scheduledExecutorService</span> <span style="color:#f92672">=</span> Executors<span style="color:#f92672">.</span><span style="color:#a6e22e">newSingleThreadScheduledExecutor</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> ThreadFactoryImpl<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ConsumeMessageScheduledThread_&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>  	<span style="color:#75715e">// 初始化清除过期消息线程池，线程数=1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">cleanExpireMsgExecutors</span> <span style="color:#f92672">=</span> Executors<span style="color:#f92672">.</span><span style="color:#a6e22e">newSingleThreadScheduledExecutor</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> ThreadFactoryImpl<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;CleanExpireMsgScheduledThread_&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>在上文介绍的pullMessage方法中，当客户端从Broker拉取消息到本地后，会调用ConsumeMessageService#submitConsumeRequest方法去提交消费请求，接下来我们会看下这个方法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">submitConsumeRequest</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>  			<span style="color:#75715e">// PullResult中从Broker拉取到的消息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">final</span> List<span style="color:#f92672">&lt;</span>MessageExt<span style="color:#f92672">&gt;</span> msgs<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>  			<span style="color:#75715e">// 消息队列副本
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">final</span> ProcessQueue processQueue<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>  			<span style="color:#75715e">// 消息队列
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">final</span> MessageQueue messageQueue<span style="color:#f92672">,</span>	
</span></span><span style="display:flex;"><span>  		  <span style="color:#75715e">// 是否转发到消费线程池 并发消费时忽略该参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> dispatchToConsume<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  	<span style="color:#75715e">// 得到批量消费的数量，由ConsumeMessageBatchMaxSize决定
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> consumeBatchSize <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumeMessageBatchMaxSize</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>msgs<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">&lt;=</span> consumeBatchSize<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      	<span style="color:#75715e">// 如果拉取的消息小于等于consumeBatchSize, 将消费请求提交到消费线程池consumeExecutor中执行
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        ConsumeRequest consumeRequest <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConsumeRequest<span style="color:#f92672">(</span>msgs<span style="color:#f92672">,</span> processQueue<span style="color:#f92672">,</span> messageQueue<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">consumeExecutor</span><span style="color:#f92672">.</span><span style="color:#a6e22e">submit</span><span style="color:#f92672">(</span>consumeRequest<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RejectedExecutionException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">submitConsumeRequestLater</span><span style="color:#f92672">(</span>consumeRequest<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      	<span style="color:#75715e">// 否则，分页处理，每页大小为 consumeBatchSize，分批提交到consumeExecutor中执行
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> total <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">;</span> total <span style="color:#f92672">&lt;</span> msgs<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">();</span> <span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            List<span style="color:#f92672">&lt;</span>MessageExt<span style="color:#f92672">&gt;</span> msgThis <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;</span>MessageExt<span style="color:#f92672">&gt;(</span>consumeBatchSize<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> consumeBatchSize<span style="color:#f92672">;</span> i<span style="color:#f92672">++,</span> total<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>total <span style="color:#f92672">&lt;</span> msgs<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    msgThis<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>msgs<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>total<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            ConsumeRequest consumeRequest <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConsumeRequest<span style="color:#f92672">(</span>msgThis<span style="color:#f92672">,</span> processQueue<span style="color:#f92672">,</span> messageQueue<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">consumeExecutor</span><span style="color:#f92672">.</span><span style="color:#a6e22e">submit</span><span style="color:#f92672">(</span>consumeRequest<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RejectedExecutionException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;</span> total <span style="color:#f92672">&lt;</span> msgs<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">();</span> total<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    msgThis<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>msgs<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>total<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">submitConsumeRequestLater</span><span style="color:#f92672">(</span>consumeRequest<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>通过上段代码可以看到，把ConsumeRequest对象放到线程池consumeExecutor中去执行，那消费逻辑就要看下ConsumeRequest#run方法，其中ConsumeRequest是ConsumeMessageConcurrentlyService的保留类，继承了Runnable接口，其run方法如下所示</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  	<span style="color:#75715e">// 当发生消息rebalance的时候，会设置dropped为true，防止消费者消费不属于自己的消息队列
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">processQueue</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isDropped</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        log<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;the message queue not be able to consume, because it&#39;s dropped. group={} {}&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                ConsumeMessageConcurrentlyService<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">consumerGroup</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">messageQueue</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    MessageListenerConcurrently listener <span style="color:#f92672">=</span> ConsumeMessageConcurrentlyService<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">messageListener</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    ConsumeConcurrentlyContext context <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConsumeConcurrentlyContext<span style="color:#f92672">(</span>messageQueue<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    ConsumeConcurrentlyStatus status <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    defaultMQPushConsumerImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">resetRetryAndNamespace</span><span style="color:#f92672">(</span>msgs<span style="color:#f92672">,</span> defaultMQPushConsumer<span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumerGroup</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ConsumeMessageContext consumeMessageContext <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 消费前钩子
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ConsumeMessageConcurrentlyService<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumerImpl</span><span style="color:#f92672">.</span><span style="color:#a6e22e">hasHook</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        consumeMessageContext <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConsumeMessageContext<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        consumeMessageContext<span style="color:#f92672">.</span><span style="color:#a6e22e">setNamespace</span><span style="color:#f92672">(</span>defaultMQPushConsumer<span style="color:#f92672">.</span><span style="color:#a6e22e">getNamespace</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        consumeMessageContext<span style="color:#f92672">.</span><span style="color:#a6e22e">setConsumerGroup</span><span style="color:#f92672">(</span>defaultMQPushConsumer<span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumerGroup</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        consumeMessageContext<span style="color:#f92672">.</span><span style="color:#a6e22e">setProps</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">&gt;());</span>
</span></span><span style="display:flex;"><span>        consumeMessageContext<span style="color:#f92672">.</span><span style="color:#a6e22e">setMq</span><span style="color:#f92672">(</span>messageQueue<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        consumeMessageContext<span style="color:#f92672">.</span><span style="color:#a6e22e">setMsgList</span><span style="color:#f92672">(</span>msgs<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        consumeMessageContext<span style="color:#f92672">.</span><span style="color:#a6e22e">setSuccess</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        ConsumeMessageConcurrentlyService<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumerImpl</span><span style="color:#f92672">.</span><span style="color:#a6e22e">executeHookBefore</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                consumeMessageContext<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">long</span> beginTimestamp <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">boolean</span> hasException <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    ConsumeReturnType returnType <span style="color:#f92672">=</span> ConsumeReturnType<span style="color:#f92672">.</span><span style="color:#a6e22e">SUCCESS</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>  	<span style="color:#75715e">// 重点！
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  	<span style="color:#75715e">// 判断msg是否为空，如果不为空，则迭代msgs，设置消费开始时间戳
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>msgs <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>msgs<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>MessageExt msg <span style="color:#f92672">:</span> msgs<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                MessageAccessor<span style="color:#f92672">.</span><span style="color:#a6e22e">setConsumeStartTimeStamp</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">,</span> String<span style="color:#f92672">.</span><span style="color:#a6e22e">valueOf</span><span style="color:#f92672">(</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">()));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 让Listener消费消息，返回消费结果
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      	<span style="color:#75715e">// 通过Collections.unmodifiableList将msgs包装成不可修改的视图
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        status <span style="color:#f92672">=</span> listener<span style="color:#f92672">.</span><span style="color:#a6e22e">consumeMessage</span><span style="color:#f92672">(</span>Collections<span style="color:#f92672">.</span><span style="color:#a6e22e">unmodifiableList</span><span style="color:#f92672">(</span>msgs<span style="color:#f92672">),</span> context<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Throwable e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 如果报错，这里置为true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        hasException <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">long</span> consumeRT <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> beginTimestamp<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">null</span> <span style="color:#f92672">==</span> status<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>hasException<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            returnType <span style="color:#f92672">=</span> ConsumeReturnType<span style="color:#f92672">.</span><span style="color:#a6e22e">EXCEPTION</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            returnType <span style="color:#f92672">=</span> ConsumeReturnType<span style="color:#f92672">.</span><span style="color:#a6e22e">RETURNNULL</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 消费超时
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>consumeRT <span style="color:#f92672">&gt;=</span> defaultMQPushConsumer<span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumeTimeout</span><span style="color:#f92672">()</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        returnType <span style="color:#f92672">=</span> ConsumeReturnType<span style="color:#f92672">.</span><span style="color:#a6e22e">TIME_OUT</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 业务侧返回CONSUME_LATER, 消费失败
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ConsumeConcurrentlyStatus<span style="color:#f92672">.</span><span style="color:#a6e22e">RECONSUME_LATER</span> <span style="color:#f92672">==</span> status<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        returnType <span style="color:#f92672">=</span> ConsumeReturnType<span style="color:#f92672">.</span><span style="color:#a6e22e">FAILED</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 业务侧返回CONSUME_SUCCESS, 消费成功
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ConsumeConcurrentlyStatus<span style="color:#f92672">.</span><span style="color:#a6e22e">CONSUME_SUCCESS</span> <span style="color:#f92672">==</span> status<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        returnType <span style="color:#f92672">=</span> ConsumeReturnType<span style="color:#f92672">.</span><span style="color:#a6e22e">SUCCESS</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 钩子
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ConsumeMessageConcurrentlyService<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumerImpl</span><span style="color:#f92672">.</span><span style="color:#a6e22e">hasHook</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        consumeMessageContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getProps</span><span style="color:#f92672">().</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>MixAll<span style="color:#f92672">.</span><span style="color:#a6e22e">CONSUME_CONTEXT_TYPE</span><span style="color:#f92672">,</span> returnType<span style="color:#f92672">.</span><span style="color:#a6e22e">name</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果客户端返回的status为null, 则赋值为RECONSUME_LATER
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">null</span> <span style="color:#f92672">==</span> status<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        status <span style="color:#f92672">=</span> ConsumeConcurrentlyStatus<span style="color:#f92672">.</span><span style="color:#a6e22e">RECONSUME_LATER</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 消费后钩子
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ConsumeMessageConcurrentlyService<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumerImpl</span><span style="color:#f92672">.</span><span style="color:#a6e22e">hasHook</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        consumeMessageContext<span style="color:#f92672">.</span><span style="color:#a6e22e">setStatus</span><span style="color:#f92672">(</span>status<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        consumeMessageContext<span style="color:#f92672">.</span><span style="color:#a6e22e">setSuccess</span><span style="color:#f92672">(</span>ConsumeConcurrentlyStatus<span style="color:#f92672">.</span><span style="color:#a6e22e">CONSUME_SUCCESS</span> <span style="color:#f92672">==</span> status<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        ConsumeMessageConcurrentlyService<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumerImpl</span><span style="color:#f92672">.</span><span style="color:#a6e22e">executeHookAfter</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                consumeMessageContext<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ConsumeMessageConcurrentlyService<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumerStatsManager</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span><span style="color:#a6e22e">incConsumeRT</span><span style="color:#f92672">(</span>ConsumeMessageConcurrentlyService<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">consumerGroup</span><span style="color:#f92672">,</span> messageQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">getTopic</span><span style="color:#f92672">(),</span>
</span></span><span style="display:flex;"><span>                    consumeRT<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>processQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">isDropped</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 处理消息消费结果
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        ConsumeMessageConcurrentlyService<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">processConsumeResult</span><span style="color:#f92672">(</span>status<span style="color:#f92672">,</span> context<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        log<span style="color:#f92672">.</span><span style="color:#a6e22e">warn</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;processQueue is dropped without process consume result. messageQueue={}, msgs={}&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                messageQueue<span style="color:#f92672">,</span> msgs<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<p>之所以当processQueue的dropped状态为true时不做任何处理，是因为当processQueue.dropped==true时，说明此时可能出现了新消费者的加入/原消费者down机等情况，导致原先消费者的队列在rebalance之后分配给了新的消费者。那么，这部分消息会被重新消费，因此此处就不需要做多余的处理，等待重新消费就可以了。</p>
</blockquote>
<p>接下来看ConsumeMessageConcurrentlyService#processConsumeResult方法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">processConsumeResult</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>  			<span style="color:#75715e">// 并行消费结果，RECONSUME_LATER或CONSUME_SUCCESS
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">final</span> ConsumeConcurrentlyStatus status<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>  			<span style="color:#75715e">// 并行消费的上下文，其中有MessageQueue, ackIndex和delayLevelWhenNextConsume
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  			<span style="color:#75715e">// ackIndex是consumeRequest.getMsgs()这个list中消费成功的idx, 初始化为Integer.MAX_VALUE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  			<span style="color:#75715e">// delayLevleWhenNextConsume用于表示该消息已经被重试了多少次
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">final</span> ConsumeConcurrentlyContext context<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>  			<span style="color:#75715e">// 消费请求
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">final</span> ConsumeRequest consumeRequest<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// consumeRequest.getMsgs()中消费成功的idx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> ackIndex <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getAckIndex</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>consumeRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getMsgs</span><span style="color:#f92672">().</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 判断消费结果，如果是CONSUMESUCCESS则设置ackIndex=msgs.size()-1;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  	<span style="color:#75715e">// 如果是RECONSUMELATER则设置ackIndex=-1。为发送消息确认ACK做准备。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>status<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> CONSUME_SUCCESS<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ackIndex <span style="color:#f92672">&gt;=</span> consumeRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getMsgs</span><span style="color:#f92672">().</span><span style="color:#a6e22e">size</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                ackIndex <span style="color:#f92672">=</span> consumeRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getMsgs</span><span style="color:#f92672">().</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> ok <span style="color:#f92672">=</span> ackIndex <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> failed <span style="color:#f92672">=</span> consumeRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getMsgs</span><span style="color:#f92672">().</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> ok<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumerStatsManager</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">.</span><span style="color:#a6e22e">incConsumeOKTPS</span><span style="color:#f92672">(</span>consumerGroup<span style="color:#f92672">,</span> consumeRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageQueue</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getTopic</span><span style="color:#f92672">(),</span> ok<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumerStatsManager</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">.</span><span style="color:#a6e22e">incConsumeFailedTPS</span><span style="color:#f92672">(</span>consumerGroup<span style="color:#f92672">,</span> consumeRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageQueue</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getTopic</span><span style="color:#f92672">(),</span> failed<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RECONSUME_LATER<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 消费失败，重置ack
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            ackIndex <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumerStatsManager</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">.</span><span style="color:#a6e22e">incConsumeFailedTPS</span><span style="color:#f92672">(</span>consumerGroup<span style="color:#f92672">,</span> consumeRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageQueue</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getTopic</span><span style="color:#f92672">(),</span>
</span></span><span style="display:flex;"><span>                            consumeRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getMsgs</span><span style="color:#f92672">().</span><span style="color:#a6e22e">size</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageModel</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> BROADCASTING<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 广播模式下，失败的消息不做任何处理
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> ackIndex <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> consumeRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getMsgs</span><span style="color:#f92672">().</span><span style="color:#a6e22e">size</span><span style="color:#f92672">();</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                MessageExt msg <span style="color:#f92672">=</span> consumeRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getMsgs</span><span style="color:#f92672">().</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>i<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                log<span style="color:#f92672">.</span><span style="color:#a6e22e">warn</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;BROADCASTING, the message consume failed, drop it, {}&#34;</span><span style="color:#f92672">,</span> msg<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> CLUSTERING<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 集群模式下，失败的消息重发
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            List<span style="color:#f92672">&lt;</span>MessageExt<span style="color:#f92672">&gt;</span> msgBackFailed <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;</span>MessageExt<span style="color:#f92672">&gt;(</span>consumeRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getMsgs</span><span style="color:#f92672">().</span><span style="color:#a6e22e">size</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        		<span style="color:#75715e">// 将 ackIndex+1 -&gt; 队尾 的消息重新消费
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> ackIndex <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> consumeRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getMsgs</span><span style="color:#f92672">().</span><span style="color:#a6e22e">size</span><span style="color:#f92672">();</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                MessageExt msg <span style="color:#f92672">=</span> consumeRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getMsgs</span><span style="color:#f92672">().</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>i<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>              	<span style="color:#75715e">// 会根据context中的delayLevleWhenNextConsume决定重试间隔
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">boolean</span> result <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">sendMessageBack</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">,</span> context<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>result<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    msg<span style="color:#f92672">.</span><span style="color:#a6e22e">setReconsumeTimes</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">.</span><span style="color:#a6e22e">getReconsumeTimes</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    msgBackFailed<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>msgBackFailed<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                consumeRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getMsgs</span><span style="color:#f92672">().</span><span style="color:#a6e22e">removeAll</span><span style="color:#f92672">(</span>msgBackFailed<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">submitConsumeRequestLater</span><span style="color:#f92672">(</span>msgBackFailed<span style="color:#f92672">,</span> consumeRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getProcessQueue</span><span style="color:#f92672">(),</span>
</span></span><span style="display:flex;"><span>                        consumeRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageQueue</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 从ProcessQueue中将成功消费的消息移出，并同步offset进度
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">long</span> offset <span style="color:#f92672">=</span> consumeRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getProcessQueue</span><span style="color:#f92672">().</span><span style="color:#a6e22e">removeMessage</span><span style="color:#f92672">(</span>consumeRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getMsgs</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>offset <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>consumeRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getProcessQueue</span><span style="color:#f92672">().</span><span style="color:#a6e22e">isDropped</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumerImpl</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getOffsetStore</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">.</span><span style="color:#a6e22e">updateOffset</span><span style="color:#f92672">(</span>consumeRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageQueue</span><span style="color:#f92672">(),</span> offset<span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div>

                

                
                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/post/file/" data-toggle="tooltip" data-placement="top" title="Java File常用操作总结">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/post/java_spi/" data-toggle="tooltip" data-placement="top" title="Java SPI发现机制">Next
                            Post &rarr;</a>
                    </li>
                    
                </ul>
                

                



            </div>

            
            
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
            

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                
                

                
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">                  
                    
                    <li>
                        <a href="mailto:is.eric.wu@gmail.com">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://weibo.com/1965461781/profile?rightmod=1&amp;wvr=6&amp;mod=personinfo">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    

		            
                    
                    <li>
                        <a target="_blank" href="/img/we_chat.JPG">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-weixin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    <li>
                        <a target="_blank" href="https://github.com/ericwu0930/">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://www.linkedin.com/in/hao-wu-5566a416a">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    
                    
                    
                    
                    
            
            
            
           
             </ul>
		<p class="copyright text-muted">
                    Copyright &copy; Eric&#39;s Blog 2023
                    <br>
                    <a href="https://themes.gohugo.io/hugo-theme-cleanwhite">CleanWhite Hugo Theme</a> by <a href="https://zhaohuabing.com">Huabing</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function loadAsync(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        loadAsync("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>






<script type="text/javascript">
    function generateCatalog(selector) {

        
        
        
        
            _containerSelector = 'div.post-container'
        

        
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        
        $(selector).html('')

        
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    


    loadAsync("\/js\/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>






</body>
</html>
