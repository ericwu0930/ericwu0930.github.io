<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="Eric&#39;s Blog">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="https://ericwu0930.github.io/img/roof.jpg">
    <meta property="twitter:image" content="https://ericwu0930.github.io/img/roof.jpg" />
    

    
    <meta name="title" content="How Tomcat works笔记" />
    <meta property="og:title" content="How Tomcat works笔记" />
    <meta property="twitter:title" content="How Tomcat works笔记" />
    

    
    <meta name="description" content="总结自《How Tomcat Works》">
    <meta property="og:description" content="总结自《How Tomcat Works》" />
    <meta property="twitter:description" content="总结自《How Tomcat Works》" />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="吴昊, Eric Wu, 吴昊的博客, Eric&#39;s Blog, 博客, 个人网站, 互联网, Web, 云原生, PaaS, Istio, Kubernetes, 微服务, Microservice">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>How Tomcat works笔记 | 吴昊的博客 | Eric&#39;s Blog</title>

    <link rel="canonical" href="/post/tomcat/">

    
    
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hugo-theme-cleanwhite.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">

    
    <link href="https://cdn.jsdelivr.net/gh/FortAwesome/Font-Awesome@5.15.1/css/all.css" rel="stylesheet" type="text/css">

    
    

    
    <script src="/js/jquery.min.js"></script>

    
    <script src="/js/bootstrap.min.js"></script>

    
    <script src="/js/hux-blog.min.js"></script>

    
    <script src="/js/lazysizes.min.js"></script>

    
    

</head>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-158682233-1', 'auto');
	
	ga('send', 'pageview');
}
</script>





<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Eric&#39;s Blog</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">All Posts</a>
                    </li>
                    
                        
                        <li>
                            <a href="/categories/java">java</a>
                        </li>
                        
                        <li>
                            <a href="/categories/jvm">jvm</a>
                        </li>
                        
                        <li>
                            <a href="/categories/linux">linux</a>
                        </li>
                        
                        <li>
                            <a href="/categories/mysql">mysql</a>
                        </li>
                        
                        <li>
                            <a href="/categories/os">os</a>
                        </li>
                        
                        <li>
                            <a href="/categories/redis">redis</a>
                        </li>
                        
                        <li>
                            <a href="/categories/spring">spring</a>
                        </li>
                        
                        <li>
                            <a href="/categories/trivial">trivial</a>
                        </li>
                        
                        <li>
                            <a href="/categories/%E7%AE%97%E6%B3%95">算法</a>
                        </li>
                        
                        <li>
                            <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C">计算机网络</a>
                        </li>
                        
                        <li>
                            <a href="/categories/%E9%9A%8F%E7%AC%94">随笔</a>
                        </li>
                        
                    
                    
		    
                        <li><a href="/top/about/">ABOUT</a></li>
                    
		            <li>
                        <a href="/search"><i class="fa fa-search"></i></a>
		           </li>
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('/img/roof.jpg')
    }
</style>

<header class="intro-header" >

    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0" title="学习笔记">
                            学习笔记
                        </a>
                        
                    </div>
                    <h1>How Tomcat works笔记</h1>
                    <h2 class="subheading">Tomcat源码分析</h2>
                    <span class="meta">
                        
                            Posted by 
                            
                                     &#34;Eric&#34;
                             
                            on 
                            Tuesday, January 3, 2023
                            
                            
                            
                            
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                
                <h2 id="1-tomcat总体架构">1. Tomcat总体架构</h2>
<!-- raw HTML omitted -->
<p>作为一个服务器，其最基本的功能就是接收其他计算机发来的请求数据并进行解析，完成相关业务处理，然后把处理结果作为相应返回给计算机，如上图所示。</p>
<p>但是把请求监听和请求处理放到一起扩展性很差，比如当我们想适配多种网络协议，但是请求处理却相同的时候。于是Tomcat将网络协议和请求处理从概念上进行分离。得到以下结构：</p>
<!-- raw HTML omitted -->
<p>Connector负责开启Socket并监听客户端的请求，返回相应数据，完成与网络协议相关的操作；Container负责具体的请求处理。</p>
<p>以上只是Tomcat非常抽象的分层，具体情况随着了解的深入逐渐细化。</p>
<h2 id="2-connector">2. Connector</h2>
<p>
  <img src="https://raw.githubusercontent.com/ericwu0930/picture_host/main/image-20230103171855639.png" alt="image-20230103171855639">

</p>
<p>Connector和Container是一一对应的，并且Connector知道Container的存在，但是Container不知道Connector的存在；</p>
<ol>
<li>
<p>初始化方法为initialize()，启动方法为start()</p>
</li>
<li>
<p>在初始化方法initialize()中，调用私有方法open得到一个ServerSocket；在该方法中没有使用ServerSocket的构造方法，而是调用了工厂方法，并产生一个ServerSocket类。</p>
</li>
<li>
<p>使用一个Stack维护一组HttpProcessor，一个HttpProcessoor在同一时刻会处理一个请求，每一个都有自己的线程。</p>
</li>
<li>
<p>在初始化方法start()方法中，会启动Connector的主线程，然后创建HttpProcessor到minProcessors；</p>
</li>
<li>
<p>在线程方法中，会使用serverSocket.accept()接收socket，然后使用createProcessor()得到一个HttpProcessor；大多数情况下，都会从Stack中获取HttpProcessor. 如果请求数量多于Stack中HttpProcessor的数量，则会创建新的HttpProcessor直至达到maxProcessors；如果maxProcessors为负数，则会无限创建。如果能得到processor则调用processor.assign方法。</p>
</li>
</ol>
<h3 id="21-httpprocessor">2.1 HttpProcessor</h3>
<p>HttpProcessor的实体用来读socket的输入流并且解析Http请求。HttpProcessor主要完成以下三个任务：</p>
<ol>
<li>解析连接</li>
<li>解析请求</li>
<li>解析请求头</li>
</ol>
<p>HttpProcessor的assign方法不能等待请求处理完成，需要直接返回。这里使用了一种委派任务模式。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">synchronized</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">assign</span><span style="color:#f92672">(</span>Socket socket<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Wait for the processor to get the previous socket
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>available<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            wait<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#75715e">// Store the newly available Socket and notify our thread
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">socket</span> <span style="color:#f92672">=</span> socket<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    available <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    notifyAll<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">synchronized</span> Socket <span style="color:#a6e22e">await</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Wait for Connector to provide a new Socket
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span><span style="color:#f92672">(!</span>available<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            wait<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span><span style="color:#66d9ef">catch</span><span style="color:#f92672">(</span>InterruptedException e<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Notify the Connector that we have received this Socket
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Socket socket <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">socket</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    available <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    notifyAll<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span><span style="color:#f92672">(</span>socket<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>其中assign和await方法都是HttpProcessor的方法，但是这两个方法在不同的线程上被调用。这两个方法互相唤醒对方。</p>
<h2 id="3-container">3. Container</h2>
<p>Container对象是为Servlet处理请求并且将response对象返回给web客户端的。Container对象实现org.apache.catalina.Container接口，并且有四种类型: Engine, Host, Context和Wrapper，按照从高到低的层级：</p>
<ol>
<li>Engine：表示整个Catalina servlet引擎</li>
<li>Host：表示一个虚拟主机</li>
<li>Contex：表示一个web应用（比如Datatalk）</li>
<li>Wrapper：表示一个独立的servlet（比如Datatalk的一个Controller）</li>
</ol>
<p>高一层级可以持有多个低层级的Container。</p>
<h3 id="31-pipelining-tasks">3.1 Pipelining Tasks</h3>
<p>在Container中，可以通过配置项来修改container的行为。这是因为Container内部使用了Pipeline的代码设计。</p>
<p>Container中持有一个Pipeline，pipeline中由持有Valve，如下图所示：</p>
<!-- raw HTML omitted -->
<p>Pipeline的接口如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Pipeline</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * &lt;p&gt;Return the Valve instance that has been distinguished as the basic
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * Valve for this Pipeline (if any).
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Valve <span style="color:#a6e22e">getBasic</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * &lt;p&gt;Set the Valve instance that has been distinguished as the basic
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * Valve for this Pipeline (if any).  Prioer to setting the basic Valve,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * the Valve&#39;s &lt;code&gt;setContainer()&lt;/code&gt; will be called, if it
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * implements &lt;code&gt;Contained&lt;/code&gt;, with the owning Container as an
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * argument.  The method may throw an &lt;code&gt;IllegalArgumentException&lt;/code&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * if this Valve chooses not to be associated with this Container, or
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * &lt;code&gt;IllegalStateException&lt;/code&gt; if it is already associated with
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * a different Container.&lt;/p&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * @param valve Valve to be distinguished as the basic Valve
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setBasic</span><span style="color:#f92672">(</span>Valve valve<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addValve</span><span style="color:#f92672">(</span>Valve valve<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Valve<span style="color:#f92672">[]</span> <span style="color:#a6e22e">getValves</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">invoke</span><span style="color:#f92672">(</span>Request request<span style="color:#f92672">,</span> Response response<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">,</span> ServletException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">removeValve</span><span style="color:#f92672">(</span>Valve valve<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>可见通过该接口可以配置Valve。另外basic valve是一个特殊的valve，总是在最后执行。</p>
<p>我们当然可以通过以下代码实现Pipeline中Valve的依次调用：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">protected</span> Valve valves<span style="color:#f92672">[]</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Valve<span style="color:#f92672">[</span><span style="color:#ae81ff">0</span><span style="color:#f92672">];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> n<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#f92672">;</span>n<span style="color:#f92672">&lt;</span>valves<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">;</span>n<span style="color:#f92672">++){</span>
</span></span><span style="display:flex;"><span>  valve<span style="color:#f92672">[</span>n<span style="color:#f92672">].</span><span style="color:#a6e22e">invoke</span><span style="color:#f92672">(...);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>但是Tomcat的设计者使用了另外一种方式，引入了一个内部类ValveContext；该内部类可以访问Pipeline类的成员。</p>
<p>因此在Pipeline的invoke方法中，会首先初始化一个ValveContext，然后调用其invokeNext方法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">invoke</span><span style="color:#f92672">(</span>Request request<span style="color:#f92672">,</span> Response response<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> SimplePipelineValveContext<span style="color:#f92672">()).</span><span style="color:#a6e22e">invokeNext</span><span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>ValveContext内部类：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SimplePipelineValveContext</span> <span style="color:#66d9ef">implements</span> ValveContext <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">int</span> stage <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">invokeNext</span><span style="color:#f92672">(</span>Request request<span style="color:#f92672">,</span> Response response<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> subscript <span style="color:#f92672">=</span> stage<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    stage <span style="color:#f92672">=</span> stage <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>subscript <span style="color:#f92672">&lt;</span> valves<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      valves<span style="color:#f92672">[</span>subscript<span style="color:#f92672">].</span><span style="color:#a6e22e">invoke</span><span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>subscript <span style="color:#f92672">==</span> valves<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>basic <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      basic<span style="color:#f92672">.</span><span style="color:#a6e22e">invoke</span><span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ServletException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;No valve&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span> 
</span></span></code></pre></div><p>在调用valve的invoke方法时，会把自己传入到valve中，然后选择在合适的时机调用valveContext的invokeNext方法，执行下一个valve的invoke方法。其调用链如下图所示：</p>
<p>
  <img src="https://raw.githubusercontent.com/ericwu0930/picture_host/main/image-20230104153135329.png" alt="image-20230104153135329">

</p>
<p>类如其名，Context持有Pipeline所有的Valve信息，并且自己维护了一个stage变量用于记录调用到了第几个Valve，把它称之为“Valve上下文”再合适不过了。</p>
<h3 id="32-wrapper">3.2 Wrapper</h3>
<p>
  <img src="https://raw.githubusercontent.com/ericwu0930/picture_host/main/image-20230104114545881.png" alt="image-20230104114545881">

</p>
<p>Wrapper中包含一个Loader，该Loader用于查找并加载Servlet。可见一个Wrapper中也只有一个Servlet。</p>
<h3 id="33-context">3.3 Context</h3>
<p>
  <img src="https://raw.githubusercontent.com/ericwu0930/picture_host/main/image-20230104114819696.png" alt="image-20230104114819696">

</p>
<p>大部分网络应用需要不止一个Servlet，因此我们这里介绍Context。由于有多个Wrapper，因此我们需要一个Mapper对象帮助我们选择一个子Container去处理指定的请求。</p>
<p>Mapper接口的格式如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Mapper</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 得到与之关联的Container
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">public</span> Container <span style="color:#a6e22e">getContainer</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setContainer</span><span style="color:#f92672">(</span>Container container<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 得到该Mapper负责的prorocol
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getProtocol</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setProtocol</span><span style="color:#f92672">(</span>String protocol<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> Container <span style="color:#a6e22e">map</span><span style="color:#f92672">(</span>Request request<span style="color:#f92672">,</span><span style="color:#66d9ef">boolean</span> update<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>在Context中维护有一个Map&lt;String,Mapper&gt;的k-v对，通过map方法得到一个Mapper，调用其map方法得到与之关联的Container。</p>
<p>Context要点概括如下：</p>
<ol>
<li>
<p>Context包含多个Wrapper</p>
</li>
<li>
<p>Context中有多个Mapper，Mapper与Wraper一一对应，通过选择某个Mapper将请求映射到Wrapper中</p>
</li>
<li>
<p>Loader和Pipeline都与Continer绑定，当Context调用invoke方法时，最后会调用BasicValve的invoke方法，该方法会调用Container的map方法选择调用某一个Wrapper的invokde方法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Wrapper wrapper <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  wrapper <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Wrapper<span style="color:#f92672">)</span>context<span style="color:#f92672">.</span><span style="color:#a6e22e">map</span><span style="color:#f92672">(</span>request<span style="color:#f92672">,</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// if a wrapper is found,its invoke method is called.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>wrapper<span style="color:#f92672">.</span><span style="color:#a6e22e">invoke</span><span style="color:#f92672">(</span>request<span style="color:#f92672">,</span>response<span style="color:#f92672">);</span>
</span></span></code></pre></div><p>
  <img src="https://raw.githubusercontent.com/ericwu0930/picture_host/main/image-20230104160420588.png" alt="image-20230104160420588">

</p>
</li>
<li>
<p>Wrapper的invokde方法会调用Context的Loader加载Servlet</p>
</li>
</ol>
<h2 id="4-lifecycle">4. Lifecycle</h2>
<p>在Catalina中，允许一个组件可以包含另外一个组件，例如一个Container类可以包含Loader类或者Manager类。由此可以形成父子结构，父结构有义务负责子结构的生命周期，例如启动或者结束。通过这样的机制，可以实现启动类的一键启动。</p>
<p>与这一机制相关的有两个接口两个类，分别为Lifecycle，LifecycleEvent，LifecycleListener以及LifecycleSupport。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Lifecycle</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 定义的事件名称
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String START_EVENT <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;start&#34;</span><span style="color:#f92672">;</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String BEFORE_START_EVENT <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;before_start&#34;</span><span style="color:#f92672">;</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String AFTER_START_EVENT <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;after_start&#34;</span><span style="color:#f92672">;</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String STOP_EVENT <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;stop&#34;</span><span style="color:#f92672">;</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String BEFORE_STOP_EVENT <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;before_stop&#34;</span><span style="color:#f92672">;</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String AFTER_STOP_EVENT <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;after_stop&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addLifecycleListener</span><span style="color:#f92672">(</span>LifecycleListener listener<span style="color:#f92672">);</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> LifecycleListener<span style="color:#f92672">[]</span> <span style="color:#a6e22e">findLifecycleListeners</span><span style="color:#f92672">();</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">removeLifecycleListener</span><span style="color:#f92672">(</span>LifecycleListener listener<span style="color:#f92672">);</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">start</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> LifecycleException<span style="color:#f92672">;</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">stop</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> LifecycleException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 生命周期事件封装类
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LifecycleEvent</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> Object data<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> Lifecycle lifecycle<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> String type<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 生命周期的监听者
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">LifecycleListener</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">lifecycleEvent</span><span style="color:#f92672">(</span>LifecycleEvent event<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Lifecycle实现类的辅助类
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 每一个Lifecycle类需要持有其lifecycle事件的监听者，当有具体的生命周期事件发生时触发监听者，并且也需要管理维护监听者数组
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Catalina把这些动作进行封装，抽象到LifecycleSupport中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LifecycleSupport</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> Lifecycle lifecycle<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> LifecycleListener listeners<span style="color:#f92672">[];</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addLifecycleListener</span><span style="color:#f92672">(</span>LifecycleListener listener<span style="color:#f92672">){...}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> LifecycleListener<span style="color:#f92672">[]</span> <span style="color:#a6e22e">findLifecycleListeners</span><span style="color:#f92672">(){...}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">fireLifecycleEvent</span><span style="color:#f92672">(</span>String type<span style="color:#f92672">,</span> Object data<span style="color:#f92672">){...}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>以SimpleContext为例，解释生命周期、生命周期事件以及生命周期监听者（只列出与之相关的成员变量以及方法）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SimpleContext</span> <span style="color:#66d9ef">implements</span> Context<span style="color:#f92672">,</span> Pipeline<span style="color:#f92672">,</span> Lifecycle<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">protected</span> LifecycleSupport lifecycle <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LifecycleSupport<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">start</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>started<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> LifecycleException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;SimpleContext has already started&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 触发启动前生命周期事件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    lifecycle<span style="color:#f92672">.</span><span style="color:#a6e22e">fireLifecycleEvent</span><span style="color:#f92672">(</span>BEFORE_START_EVENT<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    started <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 调用loader的start
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>loader <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>loader <span style="color:#66d9ef">instanceof</span> Lifecycle<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">((</span>Lifecycle<span style="color:#f92672">)</span> loader<span style="color:#f92672">).</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 调用子container的start
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Container children<span style="color:#f92672">[]</span> <span style="color:#f92672">=</span> findChildren<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> children<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>children<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#66d9ef">instanceof</span> Lifecycle<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">((</span>Lifecycle<span style="color:#f92672">)</span> children<span style="color:#f92672">[</span>i<span style="color:#f92672">]).</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 调用pipeline的start
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>pipeline <span style="color:#66d9ef">instanceof</span> Lifecycle<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">((</span>Lifecycle<span style="color:#f92672">)</span> pipeline<span style="color:#f92672">).</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 触发启动生命周期事件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    lifecycle<span style="color:#f92672">.</span><span style="color:#a6e22e">fireLifecycleEvent</span><span style="color:#f92672">(</span>START_EVENT<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 触发启动后生命周期事件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    lifecycle<span style="color:#f92672">.</span><span style="color:#a6e22e">fireLifecycleEvent</span><span style="color:#f92672">(</span>AFTER_START_EVENT<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">stop</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> LifecycleException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>started<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> LifecycleException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;SimpleContext has not been started&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 触发停止前生命周期事件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    lifecycle<span style="color:#f92672">.</span><span style="color:#a6e22e">fireLifecycleEvent</span><span style="color:#f92672">(</span>BEFORE_STOP_EVENT<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 触发停止生命周期事件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    lifecycle<span style="color:#f92672">.</span><span style="color:#a6e22e">fireLifecycleEvent</span><span style="color:#f92672">(</span>STOP_EVENT<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    started <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 调用pipeline的stop
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>pipeline <span style="color:#66d9ef">instanceof</span> Lifecycle<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">((</span>Lifecycle<span style="color:#f92672">)</span> pipeline<span style="color:#f92672">).</span><span style="color:#a6e22e">stop</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 调用子container的stop
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Container children<span style="color:#f92672">[]</span> <span style="color:#f92672">=</span> findChildren<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> children<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>children<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#66d9ef">instanceof</span> Lifecycle<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">((</span>Lifecycle<span style="color:#f92672">)</span> children<span style="color:#f92672">[</span>i<span style="color:#f92672">]).</span><span style="color:#a6e22e">stop</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 调用loader的stop
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>loader <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>loader <span style="color:#66d9ef">instanceof</span> Lifecycle<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">((</span>Lifecycle<span style="color:#f92672">)</span> loader<span style="color:#f92672">).</span><span style="color:#a6e22e">stop</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 触发停止后生命周期事件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    lifecycle<span style="color:#f92672">.</span><span style="color:#a6e22e">fireLifecycleEvent</span><span style="color:#f92672">(</span>AFTER_STOP_EVENT<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="5-loader">5. Loader</h2>
<h3 id="51-为什么tomcat需要自己的类加载器">5.1 为什么Tomcat需要自己的类加载器</h3>
<p>如果我们使用系统的类加载器去加载servlets以及其他这些servlets所需要的类，那么servlet就能够访问所有的类，包括在JVM的CLASSPATH指明的路径下的所有类和库，这是非常危险的。servlet应该只允许载入WEB-INF/classes目录及其子目录下的类，和部署到WEB-INF/lib下的类。这就是为什么Tomcat也设计自己的类加载器。</p>
<h3 id="52-java类加载机制">5.2 Java类加载机制</h3>
<p>JVM使用类加载器把类加载到内存中。Java中有三个类加载器：bootstrap类加载器，extension类加载器以及system类加载器。</p>
<ul>
<li>
<p>bootstrap类加载器用于加载所有的核心代码，比如java.lang以及java.io包下的类。</p>
</li>
<li>
<p>extension类加载器用于加载标准扩展路径下的类，比如/jdk/jre/lib/ext路径下的类。</p>
</li>
<li>
<p>application类加载器用于加载CLASSPATH路径下的类，该加载器是由<code>sun.misc.Launcher$AppClassLoader</code>实现，该类加载器负责加载用户类路径上所指定的类库。开发者可通过ClassLoader.getSystemClassLoader()方法直接获取，故又称为系统类加载器。当应用程序没有自定义类加载器时，默认采用该类加载器。。</p>
</li>
</ul>
<p>这三个层级的类加载器又具有父子关系，通过双亲委派的模式去加载类，即首先委派自己的父类去加载相关类，如果没有加载成功则尝试自己去加载类。</p>
<blockquote>
<p>为什么要通过类加载器去加载类，而不是直接new对象出来？因为在代码中可能需要动态的产生新的对象，使用new的方式只能写死产生什么样的对象。</p>
</blockquote>
<h3 id="53-loader接口">5.3 Loader接口</h3>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Loader</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> ClassLoader <span style="color:#a6e22e">getClassLoader</span><span style="color:#f92672">();</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> Container <span style="color:#a6e22e">getContainer</span><span style="color:#f92672">();</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setContainer</span><span style="color:#f92672">(</span>Container container<span style="color:#f92672">);</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> DefaultContext <span style="color:#a6e22e">getDefaultContext</span><span style="color:#f92672">();</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setDefaultContext</span><span style="color:#f92672">(</span>DefaultContext defaultContext<span style="color:#f92672">);</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">getDelegate</span><span style="color:#f92672">();</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setDelegate</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> delegate<span style="color:#f92672">);</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getInfo</span><span style="color:#f92672">();</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">getReloadable</span><span style="color:#f92672">();</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setReloadable</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> reloadable<span style="color:#f92672">);</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addPropertyChangeListener</span><span style="color:#f92672">(</span>PropertyChangeListener listener<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addRepository</span><span style="color:#f92672">(</span>String repository<span style="color:#f92672">);</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> String<span style="color:#f92672">[]</span> <span style="color:#a6e22e">findRepositories</span><span style="color:#f92672">();</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">modified</span><span style="color:#f92672">();</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">removePropertyChangeListener</span><span style="color:#f92672">(</span>PropertyChangeListener listener<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Tomcat Loader接口指的是一个web应用loader而不是一个class loader。class loader只是web loader的一个组成部分。可以通过getClassLoader来得到Loader所持有的class loader。</p>
<p>Loader通常与一个Context绑定在一起，可以通过setContainer和getContainer来构成这种联系。无论何时container需要一个servlet类的时候，即其invoke方法被调用时，container会首先请求loader的getClassLoader方法得到一个类加载器，然后会调用loadClass方法去加载Servlet类。</p>
<p>当Context中一个或多个类被修改时，Loader可以支持重加载，即不重启Tomcat的情况下重新加载一个类。为了实现这一机制，Loader接口有modified方法，如果它所持有的资源中当有一个或多个类被修改时，会被重新加载。但是它不会自己去重加载，而是通过调用Context接口的reload方法去进行。setReloadable方法和getReloadable方法用于决定Loader是否支持重加载。</p>
<p>以WebappLoader为例，其启动方法中会执行以下操作：</p>
<ul>
<li>创建一个class loader</li>
<li>设置仓库</li>
<li>设置class path</li>
<li>设置权限许可</li>
<li>为自动重加载开启一个线程</li>
</ul>
<p>如果Loader支持自动重加载，会开启一个线程，每间隔一段时间就去检查一下其持有的资源是否修改了，如果修改了就通知context去重加载:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// Loop until the termination semaphore is set
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#66d9ef">while</span> <span style="color:#f92672">(!</span>threadDone<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">// Wait for our check interval
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     threadSleep<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>started<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>       <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>       <span style="color:#75715e">// Perform our modification check
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>       <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>classLoader<span style="color:#f92672">.</span><span style="color:#a6e22e">modified</span><span style="color:#f92672">())</span>
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>       log<span style="color:#f92672">(</span>sm<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;webappLoader.failModifiedCheck&#34;</span><span style="color:#f92672">),</span> e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>       <span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">// Handle a need for reloading
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     notifyContext<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="55-classloader">5.5 ClassLoader</h3>
<p>在WebappClassLoader中有一个triggers和packageTriggers用于禁止加载某类以及某目录下得了类。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String<span style="color:#f92672">[]</span> triggers <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;javax.servlet.Servlet&#34;</span>                     <span style="color:#75715e">// Servlet API
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String<span style="color:#f92672">[]</span> packageTriggers <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;javax&#34;</span><span style="color:#f92672">,</span>                                     <span style="color:#75715e">// Java extensions
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#e6db74">&#34;org.xml.sax&#34;</span><span style="color:#f92672">,</span>                               <span style="color:#75715e">// SAX 1 &amp; 2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#e6db74">&#34;org.w3c.dom&#34;</span><span style="color:#f92672">,</span>                               <span style="color:#75715e">// DOM 1 &amp; 2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#e6db74">&#34;org.apache.xerces&#34;</span><span style="color:#f92672">,</span>                         <span style="color:#75715e">// Xerces 1 &amp; 2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#e6db74">&#34;org.apache.xalan&#34;</span>                           <span style="color:#75715e">// Xalan
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">};</span>
</span></span></code></pre></div><p>为了更好的性能，会将加载过的类以及没有找到加载的类分别放到两个Map中。加载过的类会用ResourceEntry进行封装。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ResourceEntry</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">long</span> lastModifled <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">;</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Binary content of the resource.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> binaryContent <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> Class loadedClass <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// URL source from where the object was loaded.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">public</span> URL source <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// URL of the codebase from where the object was loaded. 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">public</span> URL CodeBase <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> Manifest manifest <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> Certificate<span style="color:#f92672">[]</span> certificates <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>WebappClassLoader类加载过程分为以下几步：</p>
<ol>
<li>首先检查类中的cache，检查是否被缓存</li>
<li>如果没有则检查ClassLoader的缓存</li>
<li>如果也没有找到，则拿到application类加载器，防止web应用覆盖jdk中的基础类</li>
<li>如果开启了SecurityManager，则检查路径是否合法</li>
<li>如果delegate标志位为true，即开启了双亲委派模型，或者所寻找的类包路径在禁止加载路径中，则执行双亲委派模型（这里一般是false，所以tomcat也就违反了双亲委派模型）</li>
<li>在当前的repositories中寻找类，repositories是在Context初始化的时候被设置的，因此WebappClassLoader其实实现了Context级别的类隔离</li>
<li>如果delegate为false（即第6步没有执行），则通过双亲委派模型去执行</li>
<li>如果类还没找到，则报错</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> Class <span style="color:#a6e22e">loadClass</span><span style="color:#f92672">(</span>String name<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> resolve<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">throws</span> ClassNotFoundException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  Class clazz <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Don&#39;t load classes if class loader is stopped
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>started<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    log<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Lifecycle error : CL stopped&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ClassNotFoundException<span style="color:#f92672">(</span>name<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// (0) Check our previously loaded local class cache
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  clazz <span style="color:#f92672">=</span> findLoadedClass0<span style="color:#f92672">(</span>name<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>clazz <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>resolve<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      resolveClass<span style="color:#f92672">(</span>clazz<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>clazz<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// (0.1) Check our previously loaded class cache
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  clazz <span style="color:#f92672">=</span> findLoadedClass<span style="color:#f92672">(</span>name<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>clazz <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>resolve<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      resolveClass<span style="color:#f92672">(</span>clazz<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>clazz<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// (0.2) Try loading the class with the system class loader, to prevent
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">//       the webapp from overriding J2SE classes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//通过系统的来加载器加载此类，这里防止应用写的类覆盖了J2SE的类,这句代码非常关键，如果不写的话
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//就会造成你自己写的类有可能会把J2SE的类给替换调，另外假如你写了一个javax.servlet.Servlet类，放在当前应用的WEB-INF/class中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//如果没有此句代码的保证，那么你自己写的类就会替换到Tomcat容器Lib中包含的类
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    clazz <span style="color:#f92672">=</span> system<span style="color:#f92672">.</span><span style="color:#a6e22e">loadClass</span><span style="color:#f92672">(</span>name<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>clazz <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>resolve<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        resolveClass<span style="color:#f92672">(</span>clazz<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>clazz<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>ClassNotFoundException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Ignore
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// (0.5) Permission to access this class when using a SecurityManager
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>securityManager <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> name<span style="color:#f92672">.</span><span style="color:#a6e22e">lastIndexOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;.&#39;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>i <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        securityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">checkPackageAccess</span><span style="color:#f92672">(</span>name<span style="color:#f92672">.</span><span style="color:#a6e22e">substring</span><span style="color:#f92672">(</span><span style="color:#ae81ff">0</span><span style="color:#f92672">,</span>i<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>SecurityException se<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        String error <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Security Violation, attempt to use &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;Restricted Class: &#34;</span> <span style="color:#f92672">+</span> name<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>error<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        se<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        log<span style="color:#f92672">(</span>error<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ClassNotFoundException<span style="color:#f92672">(</span>error<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">boolean</span> delegateLoad <span style="color:#f92672">=</span> delegate <span style="color:#f92672">||</span> filter<span style="color:#f92672">(</span>name<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// (1) Delegate to our parent if requested
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>delegateLoad<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>debug <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      log<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;  Delegating to parent classloader&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    ClassLoader loader <span style="color:#f92672">=</span> parent<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>loader <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      loader <span style="color:#f92672">=</span> system<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      clazz <span style="color:#f92672">=</span> loader<span style="color:#f92672">.</span><span style="color:#a6e22e">loadClass</span><span style="color:#f92672">(</span>name<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>clazz <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>debug <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>          log<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;  Loading class from parent&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>resolve<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>          resolveClass<span style="color:#f92672">(</span>clazz<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>clazz<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>ClassNotFoundException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// (2) Search local repositories
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//调用findClass方法在webapp级别进行加载
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>debug <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    log<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;  Searching local repositories&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    clazz <span style="color:#f92672">=</span> findClass<span style="color:#f92672">(</span>name<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>clazz <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>debug <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        log<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;  Loading class from local repository&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>resolve<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        resolveClass<span style="color:#f92672">(</span>clazz<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>clazz<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>ClassNotFoundException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// (3) Delegate to parent unconditionally
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">//如果还是没有加载到类，并且不采用委托机制的话，则通过父类加载器去加载。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>delegateLoad<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>debug <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      log<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;  Delegating to parent classloader&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    ClassLoader loader <span style="color:#f92672">=</span> parent<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>loader <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      loader <span style="color:#f92672">=</span> system<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      clazz <span style="color:#f92672">=</span> loader<span style="color:#f92672">.</span><span style="color:#a6e22e">loadClass</span><span style="color:#f92672">(</span>name<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>clazz <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>debug <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>          log<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;  Loading class from parent&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>resolve<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>          resolveClass<span style="color:#f92672">(</span>clazz<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>clazz<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>ClassNotFoundException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// This class was not found
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ClassNotFoundException<span style="color:#f92672">(</span>name<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="6-会话管理session-management">6. 会话管理（Session Management）</h2>
<p>Catalina通过Manager对象来管理Session，Manager对象总是与一个Context相关联。</p>
<p>Servlet对象通过请求HttpServletRequest接口的getSession方法得到Session对象，如下所示</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> HttpSession <span style="color:#a6e22e">getSession</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>getSession<span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> HttpSession <span style="color:#a6e22e">getSession</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> create<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> doGetSession<span style="color:#f92672">(</span>create<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> HttpSession <span style="color:#a6e22e">doGetSession</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> create<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// There cannot be a session if no context has been assigned yet
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>context <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Return the current session if it exists and is valid
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>session <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>session<span style="color:#f92672">.</span><span style="color:#a6e22e">isValid</span><span style="color:#f92672">())</span>
</span></span><span style="display:flex;"><span>    session <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>session <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>session<span style="color:#f92672">.</span><span style="color:#a6e22e">getSession</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Return the requested session if it exists and is valid
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  Manager manager <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>context <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    manager <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getManager</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>manager <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>      <span style="color:#75715e">// Sessions are not supported
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>requestedSessionId <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      session <span style="color:#f92672">=</span> manager<span style="color:#f92672">.</span><span style="color:#a6e22e">findSession</span><span style="color:#f92672">(</span>requestedSessionId<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      session <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>session <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>session<span style="color:#f92672">.</span><span style="color:#a6e22e">isValid</span><span style="color:#f92672">())</span>
</span></span><span style="display:flex;"><span>      session <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>session <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>session<span style="color:#f92672">.</span><span style="color:#a6e22e">getSession</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Create a new session if requested and the response is not committed
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>create<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>context <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>response <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>      context<span style="color:#f92672">.</span><span style="color:#a6e22e">getCookies</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>      response<span style="color:#f92672">.</span><span style="color:#a6e22e">getResponse</span><span style="color:#f92672">().</span><span style="color:#a6e22e">isCommitted</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalStateException
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">(</span>sm<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;httpRequestBase.createCommitted&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  session <span style="color:#f92672">=</span> manager<span style="color:#f92672">.</span><span style="color:#a6e22e">createSession</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>session <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>session<span style="color:#f92672">.</span><span style="color:#a6e22e">getSession</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>可见每一个request都持有一个session成员变量。如果session为空时，会通过其持有的Context对象拿到Manager，然后通过Manager生产得到Session对象。</p>
<h3 id="61-sessions">6.1 Sessions</h3>
<p>
  <img src="https://raw.githubusercontent.com/ericwu0930/picture_host/main/image-20230106113955240.png" alt="image-20230106113955240">

</p>
<ol>
<li>Session对象一定是被包含在一个Manager中</li>
<li>出于安全考虑，Manager返回的Session对象是StandardSessionFacade（通过门面模式，防止Request对象通过Manager得到Session后向下转型，使用StandardSession的公有方法）</li>
<li>Session接口中有个expire方法，用于被Manager对象调用，标明该Session已过期</li>
</ol>
<h3 id="62-manager">6.2 Manager</h3>
<!-- raw HTML omitted -->
<p>在Manager对象中，通过一个map来管理Session对象，key时Session对象唯一的id，value是Session对象本身。</p>
<h4 id="621-standardmanager">6.2.1 StandardManager</h4>
<p>StandardManager实现了Lifecycle接口，当执行stop方法的时候会调用unload方法序列化所有的有效Session到SESSIONS.ser文件中。</p>
<p>StandardManager同时实现了Runnable方法，它会启动一个线程定时清理过期Session</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#75715e">// Loop until the termination semaphore is set 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">while</span> <span style="color:#f92672">(!</span>threadDone<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>    threadSleep<span style="color:#f92672">();</span> 
</span></span><span style="display:flex;"><span>    processExpires<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span> 
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>在processExpires方法中，StandardManager会遍历每一个Session对象，比较lastAccessedTime与当前时间是否超过maxInactiveInterval，然后调用Session的expire方法去过期Session实例。</p>
<h4 id="622-persistentmanagerbase">6.2.2 PersistentManagerBase</h4>
<p>与StandardManager不同的是，PersistentManagerBase持有一个Store对象，可以将管理的Session保存到第二个位置，即Store对象所表示的地方。</p>
<p>在PersistentManagerBase也实现了Runnable接口，可以使用一个独立的线程周期性的扫出或者交换活跃Session。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Loop until the termination semaphore is set 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">while</span> <span style="color:#f92672">(!</span>threadDone<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  	threadSleep<span style="color:#f92672">();</span>	
</span></span><span style="display:flex;"><span>    processExpires<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    processPersistenceChecks<span style="color:#f92672">();</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>与StandardManager相比，PersistentManagerBase的独立线程多了一个processPersistenceChecks()方法。在该方法中会调用三个其他方法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">processPersistenceChecks</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>  processMaxIdleSwaps<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>  processMaxActiveSwaps<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>  processMaxIdleBackups<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Session被换出（swap out）或者因为活跃的session数已经超过了maxActiveSessions的数目（processMaxActiveSwaps），或者因为session已经闲置了太久(processMaxIdleSwaps)。</p>
<p>因为存在swap-out的机制，session可能存在与内存中或者store中，因此findSession函数会先在自己的内存map中寻找session，如果没有，则到store中寻找。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> Session <span style="color:#a6e22e">findSession</span><span style="color:#f92672">(</span>String id<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Session session <span style="color:#f92672">=</span> <span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">findSession</span><span style="color:#f92672">(</span>id<span style="color:#f92672">);</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>session <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>session<span style="color:#f92672">);</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// not found in memory, see if the Session is in the 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  Store session <span style="color:#f92672">=</span> swapIn<span style="color:#f92672">(</span>id<span style="color:#f92672">);</span> <span style="color:#75715e">// swapIn returns an active session in the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>session<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h4 id="623-distributedmanager">6.2.3 DistributedManager</h4>
<p>DistributedManager用于集群环境中，在创建或者删除一个Session对象的时候都会通过HTTP请求通知集群中的其他节点。</p>
<p>借助ClusterSender去给其他节点发送通知，使用ClusterReceiver来接收其他节点的通知。</p>
<h3 id="63-store">6.3 Store</h3>
<p>
  <img src="https://raw.githubusercontent.com/ericwu0930/picture_host/main/image-20230106175114065.png" alt="image-20230106175114065">

</p>
<p>根据存储的目的地分类两类，一类是FileStore，一类是JDBCStore。</p>
<h2 id="7-standardwrapper">7. StandardWrapper</h2>
<p>对于每一个调来的HTTP请求，Tomcat处理流程如下：</p>
<p>
  <img src="https://raw.githubusercontent.com/ericwu0930/picture_host/main/image-20230109105150344.png" alt="image-20230109105150344">

</p>
<ul>
<li>
<p>connector首先委托processor，通过传入的socket生成request和response对象</p>
</li>
<li>
<p>connector请求StandardContext对象的invoke方法</p>
</li>
<li>
<p>StandardContext的invoke方法其Pipeline的invoke方法，最终会调用该Pipeline的Basic方法——StandardContextValve</p>
</li>
<li>
<p>StandardContextValve的invoke方法会调用Context对象的map方法得到合适的wrapper来处理request并且调用wrapper的invoke方法</p>
</li>
<li>
<p>StandardWrapper是wrapper的标准实现。StandardWrapper实例调用它自己的pipeline的invoke方法</p>
</li>
<li>
<p>StandardWrapperValve是StandardWrapper的流水线的basic valve。因此，StandardWrapperValve的invoke方法被调用。StandardWrapperValve调用wrapper的allocate方法去获得servlet的实例</p>
</li>
<li>
<p>如果servlet需要被加载，allocate方法请求load方法去加载servlet</p>
</li>
<li>
<p>StandardWrapperValve调用servlet的service方法</p>
</li>
</ul>
<h3 id="71-singlethreadmodel">7.1 SingleThreadModel</h3>
<p>SingleThreadModel是一个接口，实现了该接口Servlet必须保证同一时间只能处理一个request。但是注意，该接口并不能阻止多个Servlet实例同时访问静态字段导致的同步问题。</p>
<p>为了提高效率，通常对Servlet对象进行池化处理，对于不同的请求分配不同的Servlet对象。</p>
<h3 id="72-standardwrapper的allocate和loadservlet方法">7.2 StandardWrapper的allocate和loadServlet方法</h3>
<p>StandardWrapper的主要职责是加载与其关联的servlet并分配一个实例，但是它并不调用servlet的service方法。该工作由StandardWrapperValve对象去完成。</p>
<p>StandardWrapperValve对象会调用StandardWrapper的allocate方法，在该方法中，如果servlet被第一次调用则会首先加载该servlet。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> Servlet <span style="color:#a6e22e">allocate</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> ServletException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// If we are currently unloading this servlet, throw an exception
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>unloading<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ServletException
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">(</span>sm<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;standardWrapper.unloading&#34;</span><span style="color:#f92672">,</span> getName<span style="color:#f92672">()));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// If not SingleThreadedModel, return the same instance every time
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#75715e">// singleThreadModel是一个成员变量用于标示与之关联的servlet是否是STM，其初始值为false，但是loadServlet方法在加载Servlet时会根据Servlet是否实现了SingleThreadModel接口而改变这个成员属性
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>singleThreadModel<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">// Load and initialize our instance if necessary
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>instance <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>       <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>instance <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>           <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>             instance <span style="color:#f92672">=</span> loadServlet<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>ServletException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>             <span style="color:#66d9ef">throw</span> e<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Throwable e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>             <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ServletException
</span></span><span style="display:flex;"><span>               <span style="color:#f92672">(</span>sm<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;standardWrapper.allocate&#34;</span><span style="color:#f92672">),</span> e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">// 因为在执行完loadServlet后singleThreadModel可能会改变，因此需要重新判断
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>singleThreadModel<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>       <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>debug <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>         log<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;  Returning non-STM instance&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>       <span style="color:#75715e">// countAllocated是一个成员变量，用于记录当前正活跃的allocate请求
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>       countAllocated<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>instance<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// nInstances:当前Servlet对象数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#75715e">// maxInstances:Servlet最大数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#75715e">// instancePool:使用Stack来维护一组Servlet对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>instancePool<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>countAllocated <span style="color:#f92672">&gt;=</span> nInstances<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>       <span style="color:#75715e">// Allocate a new instance if possible, or else wait
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>       <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>nInstances <span style="color:#f92672">&lt;</span> maxInstances<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>           instancePool<span style="color:#f92672">.</span><span style="color:#a6e22e">push</span><span style="color:#f92672">(</span>loadServlet<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>           nInstances<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>ServletException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>           <span style="color:#66d9ef">throw</span> e<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Throwable e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>           <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ServletException
</span></span><span style="display:flex;"><span>             <span style="color:#f92672">(</span>sm<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;standardWrapper.allocate&#34;</span><span style="color:#f92672">),</span> e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>           instancePool<span style="color:#f92672">.</span><span style="color:#a6e22e">wait</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>debug <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>       log<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;  Returning allocated STM instance&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>     countAllocated<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>Servlet<span style="color:#f92672">)</span> instancePool<span style="color:#f92672">.</span><span style="color:#a6e22e">pop</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> Servlet <span style="color:#a6e22e">loadServlet</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> ServletException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Nothing to do if we already have an instance or an instance pool
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>singleThreadModel <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>instance <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> instance<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  PrintStream out <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>  SystemLogHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">startCapture</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>  Servlet servlet <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 首先解析Servlet的名字
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// If this &#34;servlet&#34; is really a JSP file, get the right class.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// HOLD YOUR NOSE - this is a kludge that avoids having to do special
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// case Catalina-specific code in Jasper - it also requires that the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// servlet path be replaced by the &lt;jsp-file&gt; element content in
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// order to be completely effective
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// JSP也是一种Servlet
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    String actualClass <span style="color:#f92672">=</span> servletClass<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>actualClass <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>jspFile <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      Wrapper jspWrapper <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Wrapper<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">((</span>Context<span style="color:#f92672">)</span> getParent<span style="color:#f92672">()).</span><span style="color:#a6e22e">findChild</span><span style="color:#f92672">(</span>Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">JSP_SERVLET_NAME</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>jspWrapper <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        actualClass <span style="color:#f92672">=</span> jspWrapper<span style="color:#f92672">.</span><span style="color:#a6e22e">getServletClass</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Complain if no servlet class has been specified
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>actualClass <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      unavailable<span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ServletException
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">(</span>sm<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;standardWrapper.notClass&#34;</span><span style="color:#f92672">,</span> getName<span style="color:#f92672">()));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Acquire an instance of the class loader to be used
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Loader loader <span style="color:#f92672">=</span> getLoader<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>loader <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      unavailable<span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ServletException
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">(</span>sm<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;standardWrapper.missingLoader&#34;</span><span style="color:#f92672">,</span> getName<span style="color:#f92672">()));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ClassLoader classLoader <span style="color:#f92672">=</span> loader<span style="color:#f92672">.</span><span style="color:#a6e22e">getClassLoader</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Special case class loader for a container provided servlet
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isContainerProvidedServlet<span style="color:#f92672">(</span>actualClass<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      classLoader <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getClassLoader</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>      log<span style="color:#f92672">(</span>sm<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;standardWrapper.containerServlet&#34;</span><span style="color:#f92672">,</span> getName<span style="color:#f92672">()));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Load the specified servlet class from the appropriate class loader
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 加载对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Class classClass <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>classLoader <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Using classLoader.loadClass&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        classClass <span style="color:#f92672">=</span> classLoader<span style="color:#f92672">.</span><span style="color:#a6e22e">loadClass</span><span style="color:#f92672">(</span>actualClass<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Using forName&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        classClass <span style="color:#f92672">=</span> Class<span style="color:#f92672">.</span><span style="color:#a6e22e">forName</span><span style="color:#f92672">(</span>actualClass<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>ClassNotFoundException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      unavailable<span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ServletException
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">(</span>sm<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;standardWrapper.missingClass&#34;</span><span style="color:#f92672">,</span> actualClass<span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>         e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>classClass <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      unavailable<span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ServletException
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">(</span>sm<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;standardWrapper.missingClass&#34;</span><span style="color:#f92672">,</span> actualClass<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Instantiate and initialize an instance of the servlet class itself
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 初始化对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      servlet <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Servlet<span style="color:#f92672">)</span> classClass<span style="color:#f92672">.</span><span style="color:#a6e22e">newInstance</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>ClassCastException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      unavailable<span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Restore the context ClassLoader
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ServletException
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">(</span>sm<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;standardWrapper.notServlet&#34;</span><span style="color:#f92672">,</span> actualClass<span style="color:#f92672">),</span> e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Throwable e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      unavailable<span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Restore the context ClassLoader
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ServletException
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">(</span>sm<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;standardWrapper.instantiate&#34;</span><span style="color:#f92672">,</span> actualClass<span style="color:#f92672">),</span> e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Check if loading the servlet in this web application should be allowed
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>isServletAllowed<span style="color:#f92672">(</span>servlet<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> SecurityException
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">(</span>sm<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;standardWrapper.privilegedServlet&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                      actualClass<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Special handling for ContainerServlet instances
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>servlet <span style="color:#66d9ef">instanceof</span> ContainerServlet<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>        isContainerProvidedServlet<span style="color:#f92672">(</span>actualClass<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;calling setWrapper&#34;</span><span style="color:#f92672">);</span>                  
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">((</span>ContainerServlet<span style="color:#f92672">)</span> servlet<span style="color:#f92672">).</span><span style="color:#a6e22e">setWrapper</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;after calling setWrapper&#34;</span><span style="color:#f92672">);</span>                  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Call the initialization method of this servlet
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      instanceSupport<span style="color:#f92672">.</span><span style="color:#a6e22e">fireInstanceEvent</span><span style="color:#f92672">(</span>InstanceEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">BEFORE_INIT_EVENT</span><span style="color:#f92672">,</span>servlet<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 传入一个ServletConfig对象，facade实际上就是StandardWrapper的封装对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      servlet<span style="color:#f92672">.</span><span style="color:#a6e22e">init</span><span style="color:#f92672">(</span>facade<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Invoke jspInit on JSP pages
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>loadOnStartup <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>jspFile <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Invoking jspInit
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        HttpRequestBase req <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HttpRequestBase<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        HttpResponseBase res <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HttpResponseBase<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        req<span style="color:#f92672">.</span><span style="color:#a6e22e">setServletPath</span><span style="color:#f92672">(</span>jspFile<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        req<span style="color:#f92672">.</span><span style="color:#a6e22e">setQueryString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;jsp_precompile=true&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        servlet<span style="color:#f92672">.</span><span style="color:#a6e22e">service</span><span style="color:#f92672">(</span>req<span style="color:#f92672">,</span> res<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      instanceSupport<span style="color:#f92672">.</span><span style="color:#a6e22e">fireInstanceEvent</span><span style="color:#f92672">(</span>InstanceEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">AFTER_INIT_EVENT</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                                        servlet<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>UnavailableException f<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      instanceSupport<span style="color:#f92672">.</span><span style="color:#a6e22e">fireInstanceEvent</span><span style="color:#f92672">(</span>InstanceEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">AFTER_INIT_EVENT</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                                        servlet<span style="color:#f92672">,</span> f<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      unavailable<span style="color:#f92672">(</span>f<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> f<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>ServletException f<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      instanceSupport<span style="color:#f92672">.</span><span style="color:#a6e22e">fireInstanceEvent</span><span style="color:#f92672">(</span>InstanceEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">AFTER_INIT_EVENT</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                                        servlet<span style="color:#f92672">,</span> f<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// If the servlet wanted to be unavailable it would have
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// said so, so do not call unavailable(null).
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">throw</span> f<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Throwable f<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      instanceSupport<span style="color:#f92672">.</span><span style="color:#a6e22e">fireInstanceEvent</span><span style="color:#f92672">(</span>InstanceEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">AFTER_INIT_EVENT</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                                        servlet<span style="color:#f92672">,</span> f<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// If the servlet wanted to be unavailable it would have
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// said so, so do not call unavailable(null).
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ServletException
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">(</span>sm<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;standardWrapper.initException&#34;</span><span style="color:#f92672">,</span> getName<span style="color:#f92672">()),</span> f<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Register our newly initialized instance
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 判断servlet是否实现了SingleThreadModel接口，改变Wrapper的SingleThreadModel
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    singleThreadModel <span style="color:#f92672">=</span> servlet <span style="color:#66d9ef">instanceof</span> SingleThreadModel<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>singleThreadModel<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>instancePool <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        instancePool <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Stack<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    fireContainerEvent<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;load&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    String log <span style="color:#f92672">=</span> SystemLogHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">stopCapture</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>log <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> log<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>getServletContext<span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        getServletContext<span style="color:#f92672">().</span><span style="color:#a6e22e">log</span><span style="color:#f92672">(</span>log<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        out<span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>log<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> servlet<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="73-standardwrappervavle">7.3 StandardWrapperVavle</h3>
<p>StandardWrapperValve执行的操作：</p>
<ol>
<li>
<p>通过调用StandardWrapper的allocate方法得到StandardWrapper相关联的servlet</p>
</li>
<li>
<p>通过调用createFilterChain私有方法创建与servlet相关联的filter chain</p>
</li>
<li>
<p>调用filter chain的doFilter方法，这包括调用servlet的service方法</p>
</li>
<li>
<p>释放filter chain</p>
</li>
<li>
<p>调用wrapper的deallocate方法</p>
</li>
<li>
<p>如果servlet永久性不可用，调用wrapper的unload方法</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">invoke</span><span style="color:#f92672">(</span>Request request<span style="color:#f92672">,</span>Response response<span style="color:#f92672">,</span>ValveContext valveContext<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Allocate a servlet instance to process this request
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>unavailable<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    servlet <span style="color:#f92672">=</span> wrapper<span style="color:#f92672">.</span><span style="color:#a6e22e">allocate</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Acknowlege the request
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  response<span style="color:#f92672">.</span><span style="color:#a6e22e">sendAcknowledgement</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Create the filter chain for this request
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  ApplicationFilterChain filterChain <span style="color:#f92672">=</span> createFilterChain<span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> servlet<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Call the filter chain for this request
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// NOTE: This also calls the servlet&#39;s service() method
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  filterChain<span style="color:#f92672">.</span><span style="color:#a6e22e">doFilter</span><span style="color:#f92672">(</span>sreq<span style="color:#f92672">,</span> sres<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Deallocate the allocated servlet instance
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>servlet <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    wrapper<span style="color:#f92672">.</span><span style="color:#a6e22e">deallocate</span><span style="color:#f92672">(</span>servlet<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// If this servlet has been marked permanently unavailable, 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// unload it and release this instance
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>servlet <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">(</span>wrapper<span style="color:#f92672">.</span><span style="color:#a6e22e">getAvailable</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> Long<span style="color:#f92672">.</span><span style="color:#a6e22e">MAX_VALUE</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    wrapper<span style="color:#f92672">.</span><span style="color:#a6e22e">unload</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>以上代码的核心是<code>ApplicationFilterChain filterChain = createFilterChain(request,servlet)</code>方法。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> ApplicationFilterChain <span style="color:#a6e22e">createFilterChain</span><span style="color:#f92672">(</span>Request request<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                                                     Servlet servlet<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// If there is no servlet to execute, return null
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>servlet <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Create and initialize a filter chain object
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        ApplicationFilterChain filterChain <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">new</span> ApplicationFilterChain<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        filterChain<span style="color:#f92672">.</span><span style="color:#a6e22e">setServlet</span><span style="color:#f92672">(</span>servlet<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        StandardWrapper wrapper <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>StandardWrapper<span style="color:#f92672">)</span> getContainer<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        filterChain<span style="color:#f92672">.</span><span style="color:#a6e22e">setSupport</span><span style="color:#f92672">(</span>wrapper<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstanceSupport</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Acquire the filter mappings for this Context
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        StandardContext context <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>StandardContext<span style="color:#f92672">)</span> wrapper<span style="color:#f92672">.</span><span style="color:#a6e22e">getParent</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// filterMaps和filterConfigs都是在Context中维护的
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        FilterMap filterMaps<span style="color:#f92672">[]</span> <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">findFilterMaps</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// If there are no filter mappings, we are done
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>filterMaps <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span> <span style="color:#f92672">(</span>filterMaps<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>filterChain<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Acquire the information we will need to match filter mappings
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        String requestPath <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>request <span style="color:#66d9ef">instanceof</span> HttpRequest<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            HttpServletRequest hreq <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">(</span>HttpServletRequest<span style="color:#f92672">)</span> request<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequest</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            String contextPath <span style="color:#f92672">=</span> hreq<span style="color:#f92672">.</span><span style="color:#a6e22e">getContextPath</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>contextPath <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                contextPath <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            String requestURI <span style="color:#f92672">=</span> <span style="color:#f92672">((</span>HttpRequest<span style="color:#f92672">)</span> request<span style="color:#f92672">).</span><span style="color:#a6e22e">getDecodedRequestURI</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>requestURI<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;=</span> contextPath<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">())</span>
</span></span><span style="display:flex;"><span>                requestPath <span style="color:#f92672">=</span> requestURI<span style="color:#f92672">.</span><span style="color:#a6e22e">substring</span><span style="color:#f92672">(</span>contextPath<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        String servletName <span style="color:#f92672">=</span> wrapper<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> n <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Add the relevant path-mapped filters to this filter chain
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      	<span style="color:#75715e">// 选出符合当前请求path的filterMap，filterMap与filterName一一对应
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// 然后再通过filterName找到ApplicationFilterConfig，添加到filterChain中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> filterMaps<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>matchFiltersURL<span style="color:#f92672">(</span>filterMaps<span style="color:#f92672">[</span>i<span style="color:#f92672">],</span> requestPath<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            ApplicationFilterConfig filterConfig <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>ApplicationFilterConfig<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                context<span style="color:#f92672">.</span><span style="color:#a6e22e">findFilterConfig</span><span style="color:#f92672">(</span>filterMaps<span style="color:#f92672">[</span>i<span style="color:#f92672">].</span><span style="color:#a6e22e">getFilterName</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>filterConfig <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            filterChain<span style="color:#f92672">.</span><span style="color:#a6e22e">addFilter</span><span style="color:#f92672">(</span>filterConfig<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            n<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Add filters that match on servlet name second
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// 通过servletName进行筛选过滤器，添加到filterChain中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> filterMaps<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>matchFiltersServlet<span style="color:#f92672">(</span>filterMaps<span style="color:#f92672">[</span>i<span style="color:#f92672">],</span> servletName<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            ApplicationFilterConfig filterConfig <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>ApplicationFilterConfig<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                context<span style="color:#f92672">.</span><span style="color:#a6e22e">findFilterConfig</span><span style="color:#f92672">(</span>filterMaps<span style="color:#f92672">[</span>i<span style="color:#f92672">].</span><span style="color:#a6e22e">getFilterName</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>filterConfig <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            filterChain<span style="color:#f92672">.</span><span style="color:#a6e22e">addFilter</span><span style="color:#f92672">(</span>filterConfig<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            n<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>filterChain<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="8-standardcontext">8. StandardContext</h2>
<h3 id="81-standardcontext启动过程">8.1 StandardContext启动过程</h3>
<p>在StandardContext的start方法中：</p>
<ul>
<li>
<p>触发BEFORE_START事件</p>
</li>
<li>
<p>设置<code>availability</code>属性为<code>false</code></p>
</li>
<li>
<p>设置<code>configured</code>属性为<code>false</code></p>
</li>
<li>
<p>设置<code>resources</code></p>
</li>
<li>
<p>设置<code>loader</code></p>
</li>
<li>
<p>设置会话管理<code>manager</code></p>
</li>
<li>
<p>初始化一个character set mapper</p>
</li>
<li>
<p>启动与Context相关联的其他组件</p>
</li>
<li>
<p>启动其子容器</p>
</li>
<li>
<p>启动pipeline</p>
</li>
<li>
<p>触发START事件（会触发LifecycleListener——ContextConfig，该监听器会解析web.xml完成Context的配置，并设置<code>configured</code>字段为<code>true</code>）</p>
</li>
<li>
<p>检查<code>configured</code>属性，如果为<code>true</code>则调用<code>postWelcomePages</code>方法，加载需要加载的子wrappers，并且设置<code>availablity</code>为<code>true</code></p>
</li>
<li>
<p>触发AFTER_START事件</p>
</li>
</ul>
<h3 id="82-standardcontext的invoke方法">8.2 StandardContext的invoke方法</h3>
<p>StandardContext的invoke方法被与之关联的connector调用，或者如果Context有父Host，则被host的invoke方法而调用。</p>
<p>StandardContext的invoke方法会首先检查Context是否在reloading，然后会调用其父类，ContainerBase的invoke方法，该方法会调用pipeline的invoke方法。</p>
<p>StandardContextValve是Context的pipeline的basic valve，也就是最终被调用的valve。</p>
<p>在StandardContextValve中，会先在Context中根据请求的协议找到一个Mapper对象，然后调用Mapper对象的map方法得到Wrapper。其中Mapper对象是父Container用于寻找子Container的映射类。</p>
<p>在StandardContext启动时，已经添加了一个Mapper类，即默认的StandardContextMapper。</p>
<h3 id="83-standardcontextmapper">8.3 StandardContextMapper</h3>
<p>StandardContextMapper中的核心方法是map，在该方法中会有四个匹配规则</p>
<ul>
<li>Rule 1 &ndash; Exact Match</li>
<li>Rule 2 &ndash; Prefix Match</li>
<li>Rule 3 &ndash; Extension Match</li>
<li>Rule 4 &ndash; Default Match</li>
</ul>
<p>优先级自上至下，通过relativeURI在Context的<code>servletMapping</code>成员属性中寻找与之对应的wrapperName，然后到<code>children</code>成员属性中根据wrapperName得到与之对应的wrapper。其中servletMapping是一个key为pattern，value为wrapperName的HashMap，children是key为name，value为Container的HashMap。</p>
<p>servletMapping是在Bootstrap对象中手动添加的，如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>context<span style="color:#f92672">.</span><span style="color:#a6e22e">addServletMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/Primitive&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Primitive&#34;</span><span style="color:#f92672">);</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">addServletMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/Modern&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Modern&#34;</span><span style="color:#f92672">);</span>
</span></span></code></pre></div><h3 id="84-backgroundprocess方法">8.4 backgroundProcess方法</h3>
<p>在Context中，其他组件比如loader和manager可能都需要单独的后台线程去处理自己的逻辑，比如loader需要支持自动重载或者manager清理过期session等。</p>
<p>在Tomcat4中，这些组件都拥有自己的线程。但是在Tomcat5中，为了节省资源，所有的这些后台逻辑都共享同一个线程。在ContainerBase的start方法中，会调用threadStart方法，该方法会启动一个线程执行内部类ContainerBackgroundProcessor的run方法。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ContainerBackgroundProcessor</span> <span style="color:#66d9ef">implements</span> Runnable <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            processChildren<span style="color:#f92672">(</span>ContainerBase<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">processChildren</span><span style="color:#f92672">(</span>Container container<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            ClassLoader originalClassLoader <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>container <span style="color:#66d9ef">instanceof</span> Context<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    Loader loader <span style="color:#f92672">=</span> <span style="color:#f92672">((</span>Context<span style="color:#f92672">)</span> container<span style="color:#f92672">).</span><span style="color:#a6e22e">getLoader</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// Loader will be null for FailedContext instances
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>loader <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// Ensure background processing for Contexts and Wrappers
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#75715e">// is performed under the web app&#39;s class loader
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    originalClassLoader <span style="color:#f92672">=</span> <span style="color:#f92672">((</span>Context<span style="color:#f92672">)</span> container<span style="color:#f92672">).</span><span style="color:#a6e22e">bind</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">.</span><span style="color:#a6e22e">backgroundProcess</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                Container<span style="color:#f92672">[]</span> children <span style="color:#f92672">=</span> container<span style="color:#f92672">.</span><span style="color:#a6e22e">findChildren</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Container child <span style="color:#f92672">:</span> children<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>child<span style="color:#f92672">.</span><span style="color:#a6e22e">getBackgroundProcessorDelay</span><span style="color:#f92672">()</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        processChildren<span style="color:#f92672">(</span>child<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Throwable t<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                ExceptionUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">handleThrowable</span><span style="color:#f92672">(</span>t<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                log<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span>sm<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;containerBase.backgroundProcess.error&#34;</span><span style="color:#f92672">),</span> t<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>container <span style="color:#66d9ef">instanceof</span> Context<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">((</span>Context<span style="color:#f92672">)</span> container<span style="color:#f92672">).</span><span style="color:#a6e22e">unbind</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> originalClassLoader<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>在该方法中会调用当前container的backgroundProcess方法以及子container的backgroundProcess方法。</p>
<p>在container的backgroundProcess方法中，又会调用其组件（比如Manager或Loader）的一些后台逻辑。</p>
<h2 id="9-server和service">9. Server和Service</h2>
<p>从最基本的功能来讲，服务器接收其他计算机发来的请求数据并进行解析，完成相关的业务处理，然后把处理结果作为响应返回给计算机。</p>
<p>一个最简单的服务器设计如下图所示：</p>
<p>
  <img src="https://raw.githubusercontent.com/ericwu0930/picture_host/main/image-20230202171040738.png" alt="image-20230202171040738">

</p>
<p>我们把请求的监听和请求处理逻辑放在一起扩展性很差，因为我们可能需要适配多种网络协议，但请求的处理逻辑却相同。因此我们可以将网络协议与请求处理从概念上分离，如下图所示：</p>
<p>
  <img src="https://raw.githubusercontent.com/ericwu0930/picture_host/main/image-20230202172207025.png" alt="image-20230202172207025">

</p>
<p>一个Server可以包含多个Connector和Container，Connector负责开启Socket并监听客户端请求、返回响应数据；Container负责具体的请求处理。但这样设计仍然存在问题，即需要一套复杂的规则来维护Connector到Container的映射关系。</p>
<p>为此，我们使用Service对象来维护这一映射关系</p>
<p>
  <img src="https://raw.githubusercontent.com/ericwu0930/picture_host/main/image-20230202173508106.png" alt="image-20230202173508106">

</p>
<p>Server可以拥有多个Service，在Service中可以有多个Connector但是只能有一个Container。</p>
<h2 id="10-xml解析">10. XML解析</h2>
<p>在Tomcat的启动类Bootstrap中，会配置组件以及组件的各种属性，如下所示</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Bootstrap</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    System<span style="color:#f92672">.</span><span style="color:#a6e22e">setProperty</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;catalina.base&#34;</span><span style="color:#f92672">,</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">getProperty</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;user.dir&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    Connector connector <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HttpConnector<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Wrapper wrapper1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StandardWrapper<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    wrapper1<span style="color:#f92672">.</span><span style="color:#a6e22e">setName</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Primitive&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    wrapper1<span style="color:#f92672">.</span><span style="color:#a6e22e">setServletClass</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;PrimitiveServlet&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    Wrapper wrapper2 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StandardWrapper<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    wrapper2<span style="color:#f92672">.</span><span style="color:#a6e22e">setName</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Modern&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    wrapper2<span style="color:#f92672">.</span><span style="color:#a6e22e">setServletClass</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ModernServlet&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Context context <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StandardContext<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// StandardContext&#39;s start method adds a default mapper
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    context<span style="color:#f92672">.</span><span style="color:#a6e22e">setPath</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/app1&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    context<span style="color:#f92672">.</span><span style="color:#a6e22e">setDocBase</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;app1&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    context<span style="color:#f92672">.</span><span style="color:#a6e22e">addChild</span><span style="color:#f92672">(</span>wrapper1<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    context<span style="color:#f92672">.</span><span style="color:#a6e22e">addChild</span><span style="color:#f92672">(</span>wrapper2<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    LifecycleListener listener <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SimpleContextConfig<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">((</span>Lifecycle<span style="color:#f92672">)</span> context<span style="color:#f92672">).</span><span style="color:#a6e22e">addLifecycleListener</span><span style="color:#f92672">(</span>listener<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Host host <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StandardHost<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    host<span style="color:#f92672">.</span><span style="color:#a6e22e">addChild</span><span style="color:#f92672">(</span>context<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    host<span style="color:#f92672">.</span><span style="color:#a6e22e">setName</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;localhost&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    host<span style="color:#f92672">.</span><span style="color:#a6e22e">setAppBase</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;webapps&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Loader loader <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> WebappLoader<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    context<span style="color:#f92672">.</span><span style="color:#a6e22e">setLoader</span><span style="color:#f92672">(</span>loader<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// context.addServletMapping(pattern, name);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    context<span style="color:#f92672">.</span><span style="color:#a6e22e">addServletMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/Primitive&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Primitive&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    context<span style="color:#f92672">.</span><span style="color:#a6e22e">addServletMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/Modern&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Modern&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Engine engine <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StandardEngine<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    engine<span style="color:#f92672">.</span><span style="color:#a6e22e">addChild</span><span style="color:#f92672">(</span>host<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    engine<span style="color:#f92672">.</span><span style="color:#a6e22e">setDefaultHost</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;localhost&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Service service <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StandardService<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    service<span style="color:#f92672">.</span><span style="color:#a6e22e">setName</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Stand-alone Service&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    Server server <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StandardServer<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    server<span style="color:#f92672">.</span><span style="color:#a6e22e">addService</span><span style="color:#f92672">(</span>service<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    service<span style="color:#f92672">.</span><span style="color:#a6e22e">addConnector</span><span style="color:#f92672">(</span>connector<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//StandardService class&#39;s setContainer will call all its connector&#39;s setContainer method
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    service<span style="color:#f92672">.</span><span style="color:#a6e22e">setContainer</span><span style="color:#f92672">(</span>engine<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Start the new server
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>server <span style="color:#66d9ef">instanceof</span> Lifecycle<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        server<span style="color:#f92672">.</span><span style="color:#a6e22e">initialize</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">((</span>Lifecycle<span style="color:#f92672">)</span> server<span style="color:#f92672">).</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        server<span style="color:#f92672">.</span><span style="color:#a6e22e">await</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// the program waits until the await method returns,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// i.e. until a shutdown command is received.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>LifecycleException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">(</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Shut down the server
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>server <span style="color:#66d9ef">instanceof</span> Lifecycle<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">((</span>Lifecycle<span style="color:#f92672">)</span> server<span style="color:#f92672">).</span><span style="color:#a6e22e">stop</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>LifecycleException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">(</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>可见在Bootstrap类中使用了硬代码的方式写死，如果修改则需要改代码，重新编译，非常不方便。在Tomcat中使用一种更优雅的方式，即XML解析。XML中每一个元素都可以转为Java对象，元素的属性可以表示对象的成员变量。</p>
<p>在Tomcat中，使用了Apache Commons Digester包来解析XML文件，接下来将介绍该包的用法。</p>
<h3 id="101-apache-commons-digester">10.1 Apache Commons Digester</h3>
<blockquote>
<p>官方介绍：The Digester package lets you configure an XML-&gt;Java object mapping module which triggers certain actions called rules whenever a particular pattern of nested XML elements is recognized.</p>
</blockquote>
<p>org.apache.commons.digester.Digester类是该包的主类。我们可以指定一系列规则，告知Digester在解析XML文件时，遇到element需要完成那些操作，诸如创建对象、设置属性、调用方法等。</p>
<p>在Digester中维护有一个stack，在XML中遇到一个对象时，可以选择将该对象压入栈中，然后对其进行某些操作。</p>
<p>此外，还有一个很重要的类是Rule类，在Rule类中有两个最重要的方法：<code>begin</code>和<code>end</code>，它们分别指的是在遇到一个element开始标签时执行的操作和遇到一个element结束标签时执行的操作。</p>
<p>在Digester包中预置了一些默认的Rule，比如用于创建对象的<code>ObjectCreateRule</code> ,用于设置成员属性的<code>SetPropertiesRule</code>,以及用于调用方法的<code>CallMethodRule</code>，以及用于设置两个element之间关系的<code>SetNextRule</code>。</p>
<p>以<code>ObjectCreateRule</code>为例，可见其begin方法创建了一个对象，并且压入了栈中。end方法将该对象从栈中弹出。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">begin</span><span style="color:#f92672">(</span>Attributes attributes<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Identify the name of the class to instantiate
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  String realClassName <span style="color:#f92672">=</span> className<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>attributeName <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    String value <span style="color:#f92672">=</span> attributes<span style="color:#f92672">.</span><span style="color:#a6e22e">getValue</span><span style="color:#f92672">(</span>attributeName<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>value <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      realClassName <span style="color:#f92672">=</span> value<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>digester<span style="color:#f92672">.</span><span style="color:#a6e22e">log</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isDebugEnabled</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    digester<span style="color:#f92672">.</span><span style="color:#a6e22e">log</span><span style="color:#f92672">.</span><span style="color:#a6e22e">debug</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;[ObjectCreateRule]{&#34;</span> <span style="color:#f92672">+</span> digester<span style="color:#f92672">.</span><span style="color:#a6e22e">match</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                       <span style="color:#e6db74">&#34;}New &#34;</span> <span style="color:#f92672">+</span> realClassName<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Instantiate the new object and push it on the context stack
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  Class<span style="color:#f92672">&lt;?&gt;</span> clazz <span style="color:#f92672">=</span> digester<span style="color:#f92672">.</span><span style="color:#a6e22e">getClassLoader</span><span style="color:#f92672">().</span><span style="color:#a6e22e">loadClass</span><span style="color:#f92672">(</span>realClassName<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  Object instance <span style="color:#f92672">=</span> clazz<span style="color:#f92672">.</span><span style="color:#a6e22e">newInstance</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>  digester<span style="color:#f92672">.</span><span style="color:#a6e22e">push</span><span style="color:#f92672">(</span>instance<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Process the end of this element.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">end</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Object top <span style="color:#f92672">=</span> digester<span style="color:#f92672">.</span><span style="color:#a6e22e">pop</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>digester<span style="color:#f92672">.</span><span style="color:#a6e22e">log</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isDebugEnabled</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    digester<span style="color:#f92672">.</span><span style="color:#a6e22e">log</span><span style="color:#f92672">.</span><span style="color:#a6e22e">debug</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;[ObjectCreateRule]{&#34;</span> <span style="color:#f92672">+</span> digester<span style="color:#f92672">.</span><span style="color:#a6e22e">match</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                       <span style="color:#e6db74">&#34;} Pop &#34;</span> <span style="color:#f92672">+</span> top<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>其余默认方法原理类似，当然也可以自己继承Rule类，编写自己的规则。</p>
<p>一个Demo如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;ISO-8859-1&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;employee</span> <span style="color:#a6e22e">firstName=</span><span style="color:#e6db74">&#34;Freddie&#34;</span> <span style="color:#a6e22e">lastName=</span><span style="color:#e6db74">&#34;Mercury&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;office</span> <span style="color:#a6e22e">description=</span><span style="color:#e6db74">&#34;Headquarters&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">streetName=</span><span style="color:#e6db74">&#34;Wellington Avenue&#34;</span> <span style="color:#a6e22e">streetNumber=</span><span style="color:#e6db74">&#34;223&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/office&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;office</span> <span style="color:#a6e22e">description=</span><span style="color:#e6db74">&#34;Client site&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;address</span> <span style="color:#a6e22e">streetName=</span><span style="color:#e6db74">&#34;Downing Street&#34;</span> <span style="color:#a6e22e">streetNumber=</span><span style="color:#e6db74">&#34;10&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/office&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/employee&gt;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Test02</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    String path <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">getProperty</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;user.dir&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">+</span> File<span style="color:#f92672">.</span><span style="color:#a6e22e">separator</span>  <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;etc&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    File file <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> File<span style="color:#f92672">(</span>path<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;employee2.xml&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    Digester digester <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Digester<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// add rules
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    digester<span style="color:#f92672">.</span><span style="color:#a6e22e">addObjectCreate</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;employee&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;ex15.pyrmont.digestertest.Employee&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    digester<span style="color:#f92672">.</span><span style="color:#a6e22e">addSetProperties</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;employee&#34;</span><span style="color:#f92672">);</span>    
</span></span><span style="display:flex;"><span>    digester<span style="color:#f92672">.</span><span style="color:#a6e22e">addObjectCreate</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;employee/office&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;ex15.pyrmont.digestertest.Office&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    digester<span style="color:#f92672">.</span><span style="color:#a6e22e">addSetProperties</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;employee/office&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    digester<span style="color:#f92672">.</span><span style="color:#a6e22e">addSetNext</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;employee/office&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;addOffice&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    digester<span style="color:#f92672">.</span><span style="color:#a6e22e">addObjectCreate</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;employee/office/address&#34;</span><span style="color:#f92672">,</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;ex15.pyrmont.digestertest.Address&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    digester<span style="color:#f92672">.</span><span style="color:#a6e22e">addSetProperties</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;employee/office/address&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    digester<span style="color:#f92672">.</span><span style="color:#a6e22e">addSetNext</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;employee/office/address&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;setAddress&#34;</span><span style="color:#f92672">);</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      Employee employee <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Employee<span style="color:#f92672">)</span> digester<span style="color:#f92672">.</span><span style="color:#a6e22e">parse</span><span style="color:#f92672">(</span>file<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      ArrayList offices <span style="color:#f92672">=</span> employee<span style="color:#f92672">.</span><span style="color:#a6e22e">getOffices</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>      Iterator iterator <span style="color:#f92672">=</span> offices<span style="color:#f92672">.</span><span style="color:#a6e22e">iterator</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>      System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;-------------------------------------------------&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>iterator<span style="color:#f92672">.</span><span style="color:#a6e22e">hasNext</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Office office <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Office<span style="color:#f92672">)</span> iterator<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        Address address <span style="color:#f92672">=</span> office<span style="color:#f92672">.</span><span style="color:#a6e22e">getAddress</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>office<span style="color:#f92672">.</span><span style="color:#a6e22e">getDescription</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Address : &#34;</span> <span style="color:#f92672">+</span> 
</span></span><span style="display:flex;"><span>          address<span style="color:#f92672">.</span><span style="color:#a6e22e">getStreetNumber</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; &#34;</span> <span style="color:#f92672">+</span> address<span style="color:#f92672">.</span><span style="color:#a6e22e">getStreetName</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;--------------------------------&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">catch</span><span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="102-contextconfig">10.2 ContextConfig</h3>
<p>ContextConfig是StandardContext中的一个LifecycleListener，该对象用于配置Context的一些属性，并设置其成员变量<code>configured</code>为true。ContextConfig为每一个servlet元素创建一个StandardWrapper对象，我们不再需要手动初始化wrapper。</p>
<p>在事件响应方法<code>lifecycleEvent</code>中，START_EVENT和STOP_EVENT会触发函数</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">lifecycleEvent</span><span style="color:#f92672">(</span>LifecycleEvent event<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Process the event that has occurred
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>event<span style="color:#f92672">.</span><span style="color:#a6e22e">getType</span><span style="color:#f92672">().</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>Lifecycle<span style="color:#f92672">.</span><span style="color:#a6e22e">START_EVENT</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    start<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>event<span style="color:#f92672">.</span><span style="color:#a6e22e">getType</span><span style="color:#f92672">().</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>Lifecycle<span style="color:#f92672">.</span><span style="color:#a6e22e">STOP_EVENT</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    stop<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>在start方法中，涉及到xml解析以及属性注入的方法如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">synchronized</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">start</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Process the default and application web.xml files
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// 解析default web.xml, 该xml在%CATALINE_HOME%/conf目录下
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  defaultConfig<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 解析application web.xml, 该xml在WEB-INF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  applicationConfig<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>defaultConfig()方法就是解析默认的web.xml，applicationConfig()方法是解析WEB-INF下的web.xml。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">defaultConfig</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Open the default web.xml file, if it exists
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  File file <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> File<span style="color:#f92672">(</span>Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">DefaultWebXml</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>file<span style="color:#f92672">.</span><span style="color:#a6e22e">isAbsolute</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    file <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> File<span style="color:#f92672">(</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">getProperty</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;catalina.base&#34;</span><span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>                    Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">DefaultWebXml</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  FileInputStream stream <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    stream <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FileInputStream<span style="color:#f92672">(</span>file<span style="color:#f92672">.</span><span style="color:#a6e22e">getCanonicalPath</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    stream<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    stream <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>FileNotFoundException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    log<span style="color:#f92672">(</span>sm<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;contextConfig.defaultMissing&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    log<span style="color:#f92672">(</span>sm<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;contextConfig.defaultMissing&#34;</span><span style="color:#f92672">),</span> e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Process the default web.xml file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// 锁住Digester对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>webDigester<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      InputSource is <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">new</span> InputSource<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;file://&#34;</span> <span style="color:#f92672">+</span> file<span style="color:#f92672">.</span><span style="color:#a6e22e">getAbsolutePath</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>      stream <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FileInputStream<span style="color:#f92672">(</span>file<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      is<span style="color:#f92672">.</span><span style="color:#a6e22e">setByteStream</span><span style="color:#f92672">(</span>stream<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      webDigester<span style="color:#f92672">.</span><span style="color:#a6e22e">setDebug</span><span style="color:#f92672">(</span>getDebug<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>context <span style="color:#66d9ef">instanceof</span> StandardContext<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">((</span>StandardContext<span style="color:#f92672">)</span> context<span style="color:#f92672">).</span><span style="color:#a6e22e">setReplaceWelcomeFiles</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      webDigester<span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>      webDigester<span style="color:#f92672">.</span><span style="color:#a6e22e">push</span><span style="color:#f92672">(</span>context<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      webDigester<span style="color:#f92672">.</span><span style="color:#a6e22e">parse</span><span style="color:#f92672">(</span>is<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>SAXParseException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      log<span style="color:#f92672">(</span>sm<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;contextConfig.defaultParse&#34;</span><span style="color:#f92672">),</span> e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      log<span style="color:#f92672">(</span>sm<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;contextConfig.defaultPosition&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                       <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">+</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">getLineNumber</span><span style="color:#f92672">(),</span>
</span></span><span style="display:flex;"><span>                       <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">+</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">getColumnNumber</span><span style="color:#f92672">()));</span>
</span></span><span style="display:flex;"><span>      ok <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      log<span style="color:#f92672">(</span>sm<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;contextConfig.defaultParse&#34;</span><span style="color:#f92672">),</span> e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      ok <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>stream <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>          stream<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        log<span style="color:#f92672">(</span>sm<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;contextConfig.defaultClose&#34;</span><span style="color:#f92672">),</span> e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>webDigester是ContextConfig的一个成员变量，其通过createWebDigester()方法初始化</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> Digester <span style="color:#a6e22e">createWebDigester</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  URL url <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>  Digester webDigester <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Digester<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>  webDigester<span style="color:#f92672">.</span><span style="color:#a6e22e">setValidating</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  url <span style="color:#f92672">=</span> ContextConfig<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getResource</span><span style="color:#f92672">(</span>Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">WebDtdResourcePath_22</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  webDigester<span style="color:#f92672">.</span><span style="color:#a6e22e">register</span><span style="color:#f92672">(</span>Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">WebDtdPublicId_22</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                       url<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>  url <span style="color:#f92672">=</span> ContextConfig<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getResource</span><span style="color:#f92672">(</span>Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">WebDtdResourcePath_23</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  webDigester<span style="color:#f92672">.</span><span style="color:#a6e22e">register</span><span style="color:#f92672">(</span>Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">WebDtdPublicId_23</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                       url<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 这里是解析规则
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  webDigester<span style="color:#f92672">.</span><span style="color:#a6e22e">addRuleSet</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> WebRuleSet<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>webDigester<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>其中WebRuleSet即各种规则的集合。</p>
<h2 id="11-关闭钩子">11. 关闭钩子</h2>
<p>JVM在以下两种情况下关闭：</p>
<ol>
<li>当System.exit被调用或者当最后一个非守护线程退出</li>
<li>使用者强制JVM退出，例如输入<code>CTRL+C</code></li>
</ol>
<p>当虚拟机关闭的时候，会在Runtime中并行的执行注册的关闭钩子（每个都占一个线程）。</p>
<p>注册钩子函数的方法如下：</p>
<ol>
<li>继承Thread类，并重新run方法，其内容为钩子逻辑</li>
<li>初始化钩子类</li>
<li>通过Runtime.addShutdownHook方法注册钩子函数</li>
</ol>
<p>举例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ShutdownHookDemo</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">start</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>    System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Demo&#34;</span><span style="color:#f92672">);</span> 
</span></span><span style="display:flex;"><span>    ShutdownHook ShutdownHook <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ShutdownHook<span style="color:#f92672">();</span> 
</span></span><span style="display:flex;"><span>    Runtime<span style="color:#f92672">.</span><span style="color:#a6e22e">getRuntime</span><span style="color:#f92672">().</span><span style="color:#a6e22e">addShutdownHook</span><span style="color:#f92672">(</span>ShutdownHook<span style="color:#f92672">);</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    ShutdownHookDemo demo <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ShutdownHookDemo<span style="color:#f92672">();</span> 
</span></span><span style="display:flex;"><span>    demo<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>      System<span style="color:#f92672">.</span><span style="color:#a6e22e">in</span><span style="color:#f92672">.</span><span style="color:#a6e22e">read</span><span style="color:#f92672">();</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span><span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ShutdownHook</span> <span style="color:#66d9ef">extends</span> Thread <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>      System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Shutting down&#34;</span><span style="color:#f92672">);</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="12-tomcat启动">12. Tomcat启动</h2>
<p>有两个类与Tomcat启动有关，分别为Catalina和Bootstrap。</p>
<p>Catalina用于解析server.xml文件，并start和stop Server对象。</p>
<p>Bootstrap有一个入口函数，使用类加载器去加载Catalina类，并实例化。</p>
<p>逻辑上Catalina类和Bootstrap类可以合并，但为了适配各种启动环境，以及运行模式，可能存在多个Bootstrap，因此让启动入口Bootstrap与Tomcat核心环境完全松耦合。</p>
<h2 id="13-tomcat-4-框架总结">13. Tomcat 4 框架总结</h2>
<p>
  <img src="https://raw.githubusercontent.com/ericwu0930/picture_host/main/image-20230207143727340.png" alt="image-20230207143727340">

</p>


                

                
                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/post/java_io/" data-toggle="tooltip" data-placement="top" title="Java IO类详解">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/post/omit_exception_stack/" data-toggle="tooltip" data-placement="top" title="异常堆栈信息丢失问题定位">Next
                            Post &rarr;</a>
                    </li>
                    
                </ul>
                

                



            </div>

            
            
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
            

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                
                

                
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">                  
                    
                    <li>
                        <a href="mailto:is.eric.wu@gmail.com">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://weibo.com/1965461781/profile?rightmod=1&amp;wvr=6&amp;mod=personinfo">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    

		            
                    
                    <li>
                        <a target="_blank" href="/img/we_chat.JPG">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-weixin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    <li>
                        <a target="_blank" href="https://github.com/ericwu0930/">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://www.linkedin.com/in/hao-wu-5566a416a">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    
                    
                    
                    
                    
            
            
            
           
             </ul>
		<p class="copyright text-muted">
                    Copyright &copy; Eric&#39;s Blog 2023
                    <br>
                    <a href="https://themes.gohugo.io/hugo-theme-cleanwhite">CleanWhite Hugo Theme</a> by <a href="https://zhaohuabing.com">Huabing</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function loadAsync(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        loadAsync("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>






<script type="text/javascript">
    function generateCatalog(selector) {

        
        
        
        
            _containerSelector = 'div.post-container'
        

        
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        
        $(selector).html('')

        
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    


    loadAsync("\/js\/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>






</body>
</html>
